---
title: "TFM"
output: html_document
date: "`r Sys.Date()`"
---

# Libraries

```{r}
rm(list = ls())
library(tidyverse)
library(readxl)
library(DataExplorer)
library(ARDECO)
library(slider)
library(modelsummary)
```

# ERDF expenditure data

## Loading data

```{r}
funds <- read_csv("funds.csv")

funds <- funds |>
  # Selecting only ERDF data
  filter(Fund == "ERDF") |> 
  # Selecting only relevant variables
  select(Country, NUTS2_ID, NUTS2_name, Year, 
         Programming_Period, Modelled_annual_expenditure) |> 
  rename(Budget_Cycle = Programming_Period,
         Expenditure = Modelled_annual_expenditure)
```

As per source this expenditure data uses NUTS 2013 codes

## Cleaning

```{r}
funds <- funds |> 
  # Pivoting wider to obtain 1 column per budget period
  pivot_wider(names_from = Budget_Cycle, values_from = Expenditure,
              names_glue = "expenditure_{Budget_Cycle}_budget") |> 
  arrange(NUTS2_ID, Year) 

# Getting rid of years before 1989 as the budget periods covered start in 1989
funds <- funds |> 
  filter(Year >= 1989)
```

Checking that the NUTS codes used in the expenditure data are in line with the official 2013 NUTS codes

```{r}
nuts_codes <- nuts::all_nuts_codes

# Getting the list of 2013 NUTS2 codes
nuts_2013 <- nuts_codes |> 
  filter(version == 2013) |> 
  # NUTS2 codes are 4 characters long
  filter(nchar(code) == 4) 

# Checking which countries are there. I want EU28
unique(nuts_2013$country)
# Switzerland, Iceland, Liechtenstein, Norway are not in the EU so I must filter them out
nuts_2013 <- nuts_2013 |> 
  filter(!country %in% c("Switzerland", "Iceland", "Liechtenstein", "Norway"))

# Finally convert the codes into a vector
nuts_2013 <- nuts_2013 |> 
  pull(code)

# Vector of NUTS codes present in the funds dataset
nuts_funds <- unique(funds$NUTS2_ID)

setdiff(nuts_funds, nuts_2013)
```

There are some differencies. As mentioned here: [Historic EU investment](https://cohesiondata.ec.europa.eu/stories/s/Historic-EU-payments-by-region-1988-2022/47md-x4nq), "the 2013 version of the NUTS codes is used predominantly (in the dataset)". The ones above are some exceptions which I must fix for. They are mainly NUTS 2010 codes which have not been updated

```{r}
funds <- funds |> 
  # Greece
  mutate(NUTS2_ID = case_when(
    NUTS2_ID == "EL11" ~ "EL51",
    NUTS2_ID == "EL12" ~ "EL52",
    NUTS2_ID == "EL13" ~ "EL53",
    NUTS2_ID == "EL14" ~ "EL61",
    NUTS2_ID == "EL21" ~ "EL54",
    NUTS2_ID == "EL22" ~ "EL62",
    NUTS2_ID == "EL23" ~ "EL63",
    NUTS2_ID == "EL24" ~ "EL64",
    NUTS2_ID == "EL25" ~ "EL65",
    TRUE ~ NUTS2_ID
  )) |> 
  # France
  mutate(NUTS2_ID = case_when(
    NUTS2_ID == "FR92" ~ "FRA2",
    NUTS2_ID == "FR93" ~ "FRA3",
    NUTS2_ID == "FR94" ~ "FRA4",
    TRUE ~ NUTS2_ID
  )) 

# FR91 had a boundary shift
# UKI1 UKI2 had a boundary shift
# UKZZ is a special region which I will delete anyway

# A particular case is that of Slovenia SI01 SI02 
# For some years the SI01, SI02 code is used for other years the other code is used
funds |> 
  filter(Country == "SI") |> 
  distinct(Year, NUTS2_ID) |> 
  group_by(Year) |> 
  summarise(NUTS2_ID = paste(sort(unique(NUTS2_ID)), collapse = ", ")) |> 
  arrange(Year)
# I assume this is a mistake by the data provider, but it was always meant to use the NUTS 2013 version SI03 and SI04

funds <- funds |>
  # Slovenia
  mutate(NUTS2_ID = case_when(
    NUTS2_ID == "SI01" ~ "SI03",
    NUTS2_ID == "SI02" ~ "SI04",
    TRUE ~ NUTS2_ID
  ))

#Checking
nuts_funds <- unique(funds$NUTS2_ID)
setdiff(nuts_funds, nuts_2013)
```

The rest of the regions with boundary shifts must be deleted as I cannot use their data.

```{r}
funds <- funds |> 
  filter(!NUTS2_ID %in% c("FR91", "UKI1", "UKI2", "UKZZ"))

# Now all regions in the funds dataset should have a NUTS 2013 code
nuts_funds <- unique(funds$NUTS2_ID)
setdiff(nuts_funds, nuts_2013)

# Checking also which NUTS 2013 codes are not in the funds dataset
setdiff(nuts_2013, nuts_funds)
```

Perfect, all the codes in the `funds` dataset are now in NUTS2013,the NUTS2013 codes that are not in my dataset are codes that come from boundary changes of the regions which I have deleted (plus ELZZ which we don't care about) so it makes sense.

Now I must transform from NUTS2013 codes to NUTS2021 codes as my dependent variable and covariates are going to be in NUTS2021 code. Checking all the changes that there have been in the NUTS codes from [Eurostat NUTS webpage](https://ec.europa.eu/eurostat/web/nuts/history).

```{r}
nuts_2021 <- nuts_codes |> 
  filter(version == 2021) |> 
  filter(nchar(code) == 4)
nuts_2021 <- nuts_2021 |> 
  filter(!country %in% c("Switzerland", "Iceland", "Liechtenstein", "Norway"))
nuts_2021 <- nuts_2021 |> 
  pull(code)
nuts_funds <- unique(funds$NUTS2_ID)

setdiff(nuts_funds, nuts_2021)
```

```{r}
# HR04 had some boundary change
# HU10 had some boundary change
# IE01 and IE02 had some boundary change
# LT00 had some boundary change
# PL12 had some boundary change
# UKM2 and UKM3 had some boundary change

# The rest only changed their code so I will fix for those and delete the other

funds <- funds |> 
   mutate(NUTS2_ID = case_when(
    NUTS2_ID == "FR24" ~ "FRB0",
    NUTS2_ID == "FR26" ~ "FRC1",
    NUTS2_ID == "FR43" ~ "FRC2",
    NUTS2_ID == "FR25" ~ "FRD1",
    NUTS2_ID == "FR23" ~ "FRD2",
    NUTS2_ID == "FR30" ~ "FRE1",
    NUTS2_ID == "FR22" ~ "FRE2",
    NUTS2_ID == "FR42" ~ "FRF1",
    NUTS2_ID == "FR21" ~ "FRF2",
    NUTS2_ID == "FR41" ~ "FRF3",
    NUTS2_ID == "FR51" ~ "FRG0",
    NUTS2_ID == "FR52" ~ "FRH0",
    NUTS2_ID == "FR61" ~ "FRI1",
    NUTS2_ID == "FR63" ~ "FRI2",
    NUTS2_ID == "FR53" ~ "FRI3",
    NUTS2_ID == "FR81" ~ "FRJ1",
    NUTS2_ID == "FR62" ~ "FRJ2",
    NUTS2_ID == "FR72" ~ "FRK1",
    NUTS2_ID == "FR71" ~ "FRK2",
    NUTS2_ID == "FR82" ~ "FRL0",
    NUTS2_ID == "FR83" ~ "FRM0",
    NUTS2_ID == "FRA1" ~ "FRY1",
    NUTS2_ID == "FRA2" ~ "FRY2",
    NUTS2_ID == "FRA3" ~ "FRY3",
    NUTS2_ID == "FRA4" ~ "FRY4",
    NUTS2_ID == "FRA5" ~ "FRY5",
    NUTS2_ID == "PL11" ~ "PL71",
    NUTS2_ID == "PL33" ~ "PL72",
    NUTS2_ID == "PL31" ~ "PL81",
    NUTS2_ID == "PL32" ~ "PL82",
    NUTS2_ID == "PL34" ~ "PL84",
    TRUE ~ NUTS2_ID))

funds <- funds |> 
  filter(!NUTS2_ID %in% c("IE01", "IE02", "LT00", "HU10", 
                          "PL12", "UKM2", "UKM3", "HR04"))
```

Now I'll check that each region has one name only

```{r}
# Count the pairs
counted <- funds |> group_by(NUTS2_ID, NUTS2_name) |> count() |> ungroup()
# Check which NUTS2 ID appears with two different names
duplicates <- counted |>  count(NUTS2_ID) |> filter(n>1)
duplicates

dup <- funds |> filter(NUTS2_ID == "EL51")
unique(dup$NUTS2_ID)
unique(dup$NUTS2_name)
# Just minor grammatic difference

dup <- funds |> filter(NUTS2_ID == "SI03")
unique(dup$NUTS2_ID)
unique(dup$NUTS2_name)
# Will address this below

funds <- funds |> 
  mutate(NUTS2_name = case_when(
    NUTS2_ID == "EL51" ~ "Anatoliki Makedonia, Thraki",
    TRUE ~ NUTS2_name
  ))
```

```{r}
# Count the pairs
counted <- funds |> group_by(NUTS2_ID, NUTS2_name) |> count() |> ungroup()
# Checking which NUTS2_ID have the same name
duplicates <- counted |>  count(NUTS2_name) |> filter(n>1)
duplicates

dup <- funds |> filter(NUTS2_name == "Zahodna Slovenija")
unique(dup$NUTS2_ID)
unique(dup$NUTS2_name)
# SI03 NUTS2_name must be changed to Vzhodna Slovenija
# SI04 NUTS2_name should remain Zahodna Slovenija

funds <- funds |> 
  mutate(NUTS2_name = case_when(
    NUTS2_ID == "SI03" ~ "Vzhodna Slovenija",
    NUTS2_ID == "SI04" ~ "Zahodna Slovenija",
    TRUE ~ NUTS2_name
  ))

# Checking
counted <- funds |> group_by(NUTS2_ID, NUTS2_name) |> count() |> ungroup()
duplicates <- counted |>  count(NUTS2_name) |> filter(n>1)
duplicates
```

Now I have to make sure that each row is a region in a particular year, i.e. each region should only have one row per year (no multiple rows per year). 

```{r}
counted <- funds |> group_by(NUTS2_ID, NUTS2_name) |> count() |> ungroup()
counted |> arrange(desc(n)) |> head()
# There are some regions that have more than 34 observations (which are the most since data spans from 1989 to 2022)
# This is due to the changes to the nuts code I have made above

# Checking which of the regions are duplicates
duplicates <- funds |> group_by(NUTS2_ID, NUTS2_name, Year) |> 
  count() |> 
  ungroup() |> 
  filter(n>1)
duplicates
# Only the ones that needed help before are duplicates

funds |> 
  semi_join(duplicates, by = c("NUTS2_ID", "Year")) |> 
  arrange(NUTS2_ID, Year)
# No need to do anything special because there is no overlapping of data, just need to collapse all the data in one row

funds <- funds |> 
  # Summing the expenditure per year and region
  summarise(across(starts_with("expenditure"), ~ sum(.x, na.rm = TRUE)), 
            .by = c(Country, NUTS2_ID, NUTS2_name, Year)) |> 
  # Turning all the 0s cerated by the operation above into NAs
  mutate(across(starts_with("expenditure"), ~ ifelse(.x == 0, NA, .x)))
```

Making sure that each region is present for all the years that needs to be present

```{r}
unique(funds$Country)
```

Unfortunately there is no Ireland because all its NUTS2 codes had boundary changes and thus have been deleted. There is also no Lithuania because its only NUTS 2 region has been deleted due to being split it up (thus boundary changes).

```{r}
# Counting the number of countries per year
funds |> 
  group_by(Year) |> 
  summarise(n_countries = n_distinct(Country))

# Counting the number of regions
funds |> 
  group_by(Year) |> 
  summarise(n_regions = n_distinct(NUTS2_ID))
```

As some regions are not there even in years where they should be (showed by the fluctuating number of regions/countries per year) I need to create synthetic data for them (I assume that if they are not there is because they did not recieve any money that year).

```{r}
# Making sure all regions from the 1990 are also in 1989

# Looking at the differences between the vectors of unique values
NUTS_1989 <- funds |> filter(Year == 1989) |> pull(NUTS2_ID) |> unique()
NUTS_1990 <- funds |> filter(Year == 1990) |> pull(NUTS2_ID) |> unique()
missing_1989 <- setdiff(NUTS_1990, NUTS_1989)
missing_1989

# Creating appropriate data for the missing regions
missing_1989 <- funds |> 
  filter(NUTS2_ID %in% missing_1989) |> 
  filter(Year == 1990) |> 
  # Changing the year and setting expenditure to 0
  mutate(Year = 1989,
         "expenditure_1989-1993_budget"= 0)
# Adding the data back into the original main df
funds <- funds |> 
  rbind(missing_1989) |> 
  arrange(NUTS2_ID, Year)
```

```{r}
# Looking at the '95 enlargement
NUTS_1993 <- funds |> filter(Year == 1993) |> pull(NUTS2_ID) |> unique()
NUTS_1994 <- funds |> filter(Year == 1994) |> pull(NUTS2_ID) |> unique()
missing_1993 <- setdiff(NUTS_1994, NUTS_1993)
missing_1993
# This should not be there as they were not in the EU before 1995
# This likely happens because of the statistical modelling of the expenditure

# For the countries that join the EU in 1995 I want all expenditure to be in 1995
# Create a df storing their data
df <- funds |>
  filter(Country %in% c("AT", "FI", "SE") & Year == 1994)
# Filtering them out of the main df
funds <- funds |>
  filter(!(Country %in% c("AT", "FI", "SE") & Year == 1994))
# Modifying and adding that data to the main df for year 1995
df <- df |> 
  mutate(Year = 1995) |> 
  select(Country, NUTS2_ID, NUTS2_name, Year, `expenditure_1994-1999_budget`) |> 
  rename("exp_to_be_added" = `expenditure_1994-1999_budget`)
# Adding the data back into the main df and summing the expenditure
funds <- funds |> 
  left_join(df, by = c("Country", "NUTS2_ID", "NUTS2_name", "Year")) |> 
  mutate(`expenditure_1994-1999_budget` = 
           rowSums(across(c(`expenditure_1994-1999_budget`, exp_to_be_added)), 
                   na.rm = TRUE)) |> 
  select(-exp_to_be_added) |> 
  mutate(`expenditure_1994-1999_budget` = ifelse(`expenditure_1994-1999_budget` == 0,
                                                 NA, `expenditure_1994-1999_budget`))
```

```{r}
# Now the '95 enlargement is fine
NUTS_1994 <- funds |> filter(Year == 1994) |> pull(NUTS2_ID) |> unique()
NUTS_1995 <- funds |> filter(Year == 1995) |> pull(NUTS2_ID) |> unique()
missing_1994 <- setdiff(NUTS_1995, NUTS_1994)
missing_1994
# Only regions from the countries that joined in '95 make up the difference
```

```{r}
# From the 2000s regions of the 2004 enlargement appear
NUTS_1999 <- funds |> filter(Year == 1999) |> pull(NUTS2_ID) |> unique()
NUTS_2000 <- funds |> filter(Year == 2000) |> pull(NUTS2_ID) |> unique()
missing_2000 <- setdiff(NUTS_2000, NUTS_1999)
missing_2000
NUTS_2001 <- funds |> filter(Year == 2001) |> pull(NUTS2_ID) |> unique()
missing_2001 <- setdiff(NUTS_2001, NUTS_2000)
missing_2001
NUTS_2002 <- funds |> filter(Year == 2002) |> pull(NUTS2_ID) |> unique()
missing_2002 <- setdiff(NUTS_2002, NUTS_2001)
missing_2002

# This is the same problem as for the previous enlargement
# Creating a df storing the data for the countries that joined in 2004 in the years before
df <- funds |>
  filter(Country %in% c("CY", "CZ", "LV", "MT", "PL", "SK", "SI", "HU", "EE") & 
           Year %in% c(2000, 2001, 2002, 2003))
# Deleting that same data from the main df
funds <- funds |>
  filter(!(Country %in% c("CY", "CZ", "LV", "MT", "PL", "SK", "SI", "HU", "EE") & 
           Year %in% c(2000, 2001, 2002, 2003)))
# Modifying the data in an appropriate way
df <- df |> 
  # Changing the year
  mutate(Year = 2004) |> 
  select(Country, NUTS2_ID, NUTS2_name, Year, `expenditure_2000-2006_budget`) |>
  # Summing all the expenditure for the years before (which have all been changed to 2004)
  summarise(exp_to_be_added = sum(`expenditure_2000-2006_budget`, na.rm = TRUE), 
            .by = c(Country, NUTS2_ID, NUTS2_name, Year))
# Adding the data back into the main original df and summing expenditure
funds <- funds |> 
  left_join(df, by = c("Country", "NUTS2_ID", "NUTS2_name", "Year")) |> 
  mutate(`expenditure_2000-2006_budget` = 
           rowSums(across(c(`expenditure_2000-2006_budget`, exp_to_be_added)), 
                   na.rm = TRUE)) |> 
  select(-exp_to_be_added) |> 
  mutate(`expenditure_2000-2006_budget` = ifelse(`expenditure_2000-2006_budget` == 0,
                                                 NA, `expenditure_2000-2006_budget`))
```

```{r}
# Some regions do not appear for a few years, I assume they did not receive any money
NUTS_2004 <- funds |> filter(Year == 2004) |> pull(NUTS2_ID) |> unique()
NUTS_2005 <- funds |> filter(Year == 2005) |> pull(NUTS2_ID) |> unique()
missing_2005 <- setdiff(NUTS_2004, NUTS_2005)
missing_2005
NUTS_2006 <- funds |> filter(Year == 2006) |> pull(NUTS2_ID) |> unique()
missing_2006 <- setdiff(NUTS_2004, NUTS_2006)
missing_2006
# Fixing for 2005
missing_2005 <- funds |> 
  filter(NUTS2_ID %in% missing_2005) |> 
  filter(Year == 2004) |> 
  mutate(Year = 2005,
         "expenditure_2000-2006_budget"= 0)
funds <- funds |> 
  rbind(missing_2005) |> 
  arrange(NUTS2_ID, Year)
# Fixing for 2006
missing_2006 <- funds |> 
  filter(NUTS2_ID %in% missing_2006) |> 
  filter(Year == 2004) |> 
  mutate(Year = 2006,
         "expenditure_2000-2006_budget"= 0)
funds <- funds |> 
  rbind(missing_2006) |> 
  arrange(NUTS2_ID, Year)
```

```{r}
# Checking enlargement '07
NUTS_2006 <- funds |> filter(Year == 2006) |> pull(NUTS2_ID) |> unique()
NUTS_2007 <- funds |> filter(Year == 2007) |> pull(NUTS2_ID) |> unique()
missing_2006 <- setdiff(NUTS_2007, NUTS_2006)
# Croatia appears earlier than it should
missing_2006

# Again I will set all expenditure for Croatia to be in 2013
df <- funds |>
  filter(Country == "HR" & 
           Year %in% c(2007, 2008, 2009, 2010, 2011, 2012))
# Filtering them out of the main df
funds <- funds |>
  filter(!(Country == "HR" & 
           Year %in% c(2007, 2008, 2009, 2010, 2011, 2012)))
# Modifying and adding that data to the main df for year 2013
df <- df |> 
  mutate(Year = 2013) |> 
  select(Country, NUTS2_ID, NUTS2_name, Year, `expenditure_2007-2013_budget`) |> 
  summarise(exp_to_be_added = sum(`expenditure_2007-2013_budget`, na.rm = TRUE), 
            .by = c(Country, NUTS2_ID, NUTS2_name, Year))
funds <- funds |> 
  left_join(df, by = c("Country", "NUTS2_ID", "NUTS2_name", "Year")) |> 
  mutate(`expenditure_2007-2013_budget` = 
           rowSums(across(c(`expenditure_2007-2013_budget`, exp_to_be_added)), 
                   na.rm = TRUE)) |> 
  select(-exp_to_be_added) |> 
  mutate(`expenditure_2007-2013_budget` = ifelse(`expenditure_2007-2013_budget` == 0,
                                                 NA, `expenditure_2007-2013_budget`))
```

Now everything should be fine (except I should look more into what happens and what to do with Brexit)

```{r}
# Counting the number of countries per year
funds |> 
  group_by(Year) |> 
  summarise(n_countries = n_distinct(Country))

# Counting the number of regions
funds |> 
  group_by(Year) |> 
  summarise(n_regions = n_distinct(NUTS2_ID))
```

Setting the NAs for all the cells that are outside of the expenditure timeframe and setting 0s in the case that there is no expenditure, but observations are within the expenditure timeframe.

```{r}
# '89-'93 goes on until '98
funds |>  filter(`expenditure_1989-1993_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_1989-1993_budget` = case_when(
      Year >= 1989 & Year <= 1998 & is.na(`expenditure_1989-1993_budget`) ~ 0,
      Year < 1989 | Year > 1998 ~ NA,
      TRUE ~ `expenditure_1989-1993_budget`))

# '94-'99 goes on until '02
funds |>  filter(`expenditure_1994-1999_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_1994-1999_budget` = case_when(
      Year >= 1994 & Year <= 2002 & is.na(`expenditure_1994-1999_budget`) ~ 0,
      Year < 1994 | Year > 2002 ~ NA,
      TRUE ~ `expenditure_1994-1999_budget`))

# '00-'06 goes on until '09
funds |>  filter(`expenditure_2000-2006_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_2000-2006_budget` = case_when(
      Year >= 2000 & Year <= 2009 & is.na(`expenditure_2000-2006_budget`) ~ 0,
      Year < 2000 | Year > 2009 ~ NA,
      TRUE ~ `expenditure_2000-2006_budget`))

# '07-'13 goes on until '15
funds |>  filter(`expenditure_2007-2013_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_2007-2013_budget` = case_when(
      Year >= 2007 & Year <= 2015 & is.na(`expenditure_2007-2013_budget`) ~ 0,
      Year < 2007 | Year > 2015 ~ NA,
      TRUE ~ `expenditure_2007-2013_budget`))

# '14-'20 goes on until '22
funds |>  filter(`expenditure_2014-2020_budget` > 0) |> 
  summarise(min(Year), max(Year))
# Modifying the dataframe accordignly
funds <- funds |>
  mutate(
    `expenditure_2014-2020_budget` = case_when(
      Year >= 2014 & Year <= 2022 & is.na(`expenditure_2014-2020_budget`) ~ 0,
      Year < 2014 | Year > 2022 ~ NA,
      TRUE ~ `expenditure_2014-2020_budget`))
```

# Other data

These are all the variables available in the ARDECO database

```{r}
available_variables <- ardeco_get_variable_list()
head(available_variables)
```

## Unemployment

```{r}
ardeco_get_dataset_list("RNUTN")

# unemployment <- ardeco_get_dataset_data("RNUTN", version = "2021", level = "2")
# write.csv(unemployment, "unemployment.csv", row.names = FALSE)

unemployment <- read_csv("unemployment.csv")

unemployment <- unemployment |> 
  filter(YEAR <= 2022) |> 
  filter(YEAR >= 1989)
head(unemployment)

unique(unemployment$NUTSCODE) |> setdiff(unique(funds$NUTS2_ID))
unique(funds$NUTS2_ID) |> setdiff(unique(unemployment$NUTSCODE))
# It looks like all unemployment data is present only 1 regions is missing
```

Merging unemployment data with expenditure data

```{r}
unemployment <- unemployment |> 
  select(NUTSCODE, YEAR, VALUE)

data <- funds |> 
  left_join(unemployment, by = join_by(NUTS2_ID == NUTSCODE, Year == YEAR)) |> 
  rename(unemployment = VALUE)
```

## GDP

```{r}
ardeco_get_dataset_list("SOVGDP")

# gdp <- ardeco_get_dataset_data("SOVGDP", version = "2021", level = "2")
# write.csv(gdp, "gdp.csv", row.names = FALSE)

gdp <- read_csv("gdp.csv")

gdp <- gdp |> 
  filter(YEAR <= 2022) |> 
  filter(YEAR >= 1989) |> 
  filter(UNIT == "EUR2015") 
head(gdp)

unique(gdp$NUTSCODE) |> setdiff(unique(funds$NUTS2_ID))
unique(funds$NUTS2_ID) |> setdiff(unique(gdp$NUTSCODE))
# It looks like all gdp data is present
```

Merging gdp data with expenditure data

```{r}
gdp <- gdp |> 
  select(NUTSCODE, YEAR, VALUE)

data <- data |> 
  left_join(gdp, by = join_by(NUTS2_ID == NUTSCODE, Year == YEAR)) |> 
  rename(gdp = VALUE)
```

## Population

```{r}
ardeco_get_dataset_list("SNPTD")

# population <- ardeco_get_dataset_data("SNPTD", version = "2021", level = "2")
# write.csv(population, "population.csv", row.names = FALSE)

population <- read_csv("population.csv")

population <- population |> 
  filter(YEAR <= 2022) |> 
  filter(YEAR >= 1989)
head(population)

unique(population$NUTSCODE) |> setdiff(unique(funds$NUTS2_ID))
unique(funds$NUTS2_ID) |> setdiff(unique(population$NUTSCODE))
# It looks like all population data is present
```

Merging population data with expenditure data

```{r}
population <- population |> 
  select(NUTSCODE, YEAR, VALUE)

data <- data |> 
  left_join(population, by = join_by(NUTS2_ID == NUTSCODE, Year == YEAR)) |> 
  rename(population = VALUE)
```

## Education

```{r}
ardeco_get_dataset_list("RPDTN")

# education <- ardeco_get_dataset_data("RPDTN", version = "2021", level = "2")
# write.csv(education, "education.csv", row.names = FALSE)

education <- read_csv("education.csv")

education <- education |> 
  filter(YEAR <= 2022) |> 
  filter(YEAR >= 1989)
head(education)

education <- education |> 
  filter(ISCED11 == "Tertiary education (levels 5-8)")

unique(education$NUTSCODE) |> setdiff(unique(funds$NUTS2_ID))
unique(funds$NUTS2_ID) |> setdiff(unique(education$NUTSCODE))
# It looks like all education data is present
```

Merging education data with expenditure data

```{r}
education <- education |> 
  select(NUTSCODE, YEAR, VALUE)

data <- data |> 
  left_join(education, by = join_by(NUTS2_ID == NUTSCODE, Year == YEAR)) |> 
  rename(education = VALUE)
```

## Investment

```{r}
ardeco_get_dataset_list("ROIGT")

# investment <- ardeco_get_dataset_data("ROIGT", version = "2021", level = "2")
# write.csv(investment, "investment.csv", row.names = FALSE)

investment <- read_csv("investment.csv")

investment <- investment |> 
  filter(YEAR <= 2022) |> 
  filter(YEAR >= 1989) |> 
  filter(UNIT == "Million EUR2015")
head(investment)

unique(investment$NUTSCODE) |> setdiff(unique(funds$NUTS2_ID))
unique(funds$NUTS2_ID) |> setdiff(unique(investment$NUTSCODE))
# It looks like all investment data is present
```

Merging investment data with expenditure data

```{r}
investment <- investment |> 
  select(NUTSCODE, YEAR, VALUE)

data <- data |> 
  left_join(investment, by = join_by(NUTS2_ID == NUTSCODE, Year == YEAR)) |> 
  rename(investment = VALUE)
```



```{r}
min(education$YEAR)

# education data is only from 2000 onward so I am probably only going to keep data from that year onward

data <- data |> 
  # filter(Year >= 2000) |> 
  select(-`expenditure_1989-1993_budget`)
```


## Binary - poor regions

2014-2020

From [decision](https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX:32014D0099#ntr1-L_2014050EN.01002401-E0001)

```{r}
cat14_20 <- read_csv("cat14_20.csv")

# Selecting only the least developed regions
cat14_20 <- cat14_20 |> 
  select(nuts_id, catg_name) |> 
  filter(catg_name == "Less developed")

# NUTS 2006 used by this categorization vs NUTS 2021 used in our dataset
# Which of these regions is not present in the dataset due to NUTS discrepancies
missing_regions <- anti_join(cat14_20, data, by = c("nuts_id" = "NUTS2_ID"))

# Regions which I have deleted because I couldn't use their data
deleted_regions <- c("FR91", "UKI1", "UKI2", "UKZZ", "IE01", "IE02", 
                     "LT00", "HU10", "PL12", "UKM2", "UKM3", "HR04")

# Regions that I should try to identify
missing_regions <- missing_regions |> 
  filter(!nuts_id %in% deleted_regions)
missing_regions

# These are all regions which have undergone only code name changes or minor reshuffling 
cat14_20 <- cat14_20 |> 
  mutate(nuts_id = case_when(
    nuts_id == "GR11" ~ "EL51",
    nuts_id == "GR12" ~ "EL52",
    nuts_id == "GR14" ~ "EL61",
    nuts_id == "GR21" ~ "EL54",
    nuts_id == "GR23" ~ "EL63",
    nuts_id == "FR92" ~ "FRY2",
    nuts_id == "FR93" ~ "FRY3",
    nuts_id == "FR94" ~ "FRY4",
    nuts_id == "PL11" ~ "PL71",
    nuts_id == "PL31" ~ "PL81",
    nuts_id == "PL32" ~ "PL82",
    nuts_id == "PL33" ~ "PL72",
    nuts_id == "PL34" ~ "PL84",
    nuts_id == "SI01" ~ "SI03",
    TRUE ~ nuts_id
  ))

anti_join(cat14_20, data, by = c("nuts_id" = "NUTS2_ID"))
```

```{r}
data <- data |> 
  left_join(cat14_20, by = c("NUTS2_ID" = "nuts_id")) |> 
  rename(poor14_20 = catg_name) |> 
  mutate(poor14_20 = case_when(
    Year >= 2014 & is.na(poor14_20) ~ 0,
    Year >= 2014 & poor14_20 == "Less developed" ~ 1,
    Year < 2014 ~ NA,
  ))
```

2007-2013

From [decision](https://eur-lex.europa.eu/legal-content/EN/ALL/?uri=CELEX%3A32006D0595) and [decision](https://eur-lex.europa.eu/legal-content/EN/ALL/?uri=CELEX%3A32007D0189)


```{r}
cat07_13 <- read_csv("cat07_13.csv")

# Selecting only the least developed regions
cat07_13 <- cat07_13 |> 
  select(nuts_id, objective_code) |> 
  filter(objective_code == "Conv")

# Which of these regions is not present in the dataset due to NUTS discrepancies
missing_regions <- anti_join(cat07_13, data, by = c("nuts_id" = "NUTS2_ID"))

# Regions which I have deleted because I couldn't use their data
deleted_regions <- c("FR91", "UKI1", "UKI2", "UKZZ", "IE01", "IE02", 
                     "LT00", "HU10", "PL12", "UKM2", "UKM3", "HR04")

# Regions that I should try to identify
missing_regions <- missing_regions |> 
  filter(!nuts_id %in% deleted_regions)
missing_regions

# These are all regions which have undergone only code name changes or minor reshuffling 
cat07_13 <- cat07_13 |> 
  mutate(nuts_id = case_when(
    nuts_id == "DE41" ~ "DE40",
    nuts_id == "DED1" ~ "DED4",
    # DEE0 was created by merging DEE1 (poor), DEE2 (phasing out), DEE3 (poor)
    # So I'll consider it poor and I'll convert one of their code into DE00 in here
    # and then deleting the other below
    nuts_id == "DEE1" ~ "DEE0",
    nuts_id == "GR11" ~ "EL51",
    nuts_id == "GR14" ~ "EL61",
    nuts_id == "GR21" ~ "EL54",
    nuts_id == "GR22" ~ "EL62",
    nuts_id == "GR23" ~ "EL63",
    nuts_id == "GR25" ~ "EL65",
    nuts_id == "GR41" ~ "EL41",
    nuts_id == "GR43" ~ "EL43",
    nuts_id == "FR92" ~ "FRY2",
    nuts_id == "FR93" ~ "FRY3",
    nuts_id == "FR94" ~ "FRY4",
    # In the commission decision BG and RO use different codes which are more current
    nuts_id == "BG11" ~ "BG31",
    nuts_id == "BG12" ~ "BG32",
    nuts_id == "BG13" ~ "BG33",
    nuts_id == "BG21" ~ "BG34",
    nuts_id == "BG22" ~ "BG41",
    nuts_id == "BG23" ~ "BG42",
    nuts_id == "PL11" ~ "PL71",
    nuts_id == "PL31" ~ "PL81",
    nuts_id == "PL32" ~ "PL82",
    nuts_id == "PL33" ~ "PL72",
    nuts_id == "PL34" ~ "PL84",
    nuts_id == "RO01" ~ "RO21",
    nuts_id == "RO02" ~ "RO22",
    nuts_id == "RO03" ~ "RO31",
    nuts_id == "RO04" ~ "RO41",
    nuts_id == "RO05" ~ "RO42",
    nuts_id == "RO06" ~ "RO11",
    nuts_id == "RO07" ~ "RO12",
    nuts_id == "RO08" ~ "RO32",
    TRUE ~ nuts_id
  )) |> 
  filter(nuts_id != "DEE3") |>
  # Slovenia SI00 was split into SI01 and SI02 which are then recoded as SI03 and SI04
  # So I need to add those two lines
  filter(nuts_id != "SI00") |>
  rbind(c("SI03", "Conv")) |>
  rbind(c("SI04", "Conv"))

anti_join(cat07_13, data, by = c("nuts_id" = "NUTS2_ID"))
```

```{r}
data <- data |> 
  left_join(cat07_13, by = c("NUTS2_ID" = "nuts_id")) |> 
  rename(poor07_13 = objective_code) |> 
  mutate(poor07_13 = case_when(
    Year >= 2007 & Year <=2013 & is.na(poor07_13) ~ 0,
    Year >= 2007 & Year <=2013 & poor07_13 == "Conv" ~ 1,
    Year < 2007 ~ NA,
    Year > 2013 ~ NA
  ))
```


2000-2006

From [decision](https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX%3A01999D0502-20040501)


```{r}
cat00_06 <- read_csv("cat00_06.csv")

cat00_06 <- cat00_06 |> 
  # Selecting only the least developed regions: objective 1
  filter(pop_obj1 > 0) |> 
  # Converting NUTS3 into NUTS2 codes
  mutate(nuts_id = substr(nuts_id, 1, 4)) |> 
  pull(nuts_id) |> 
  unique()

# Adding a dummy which will then be merged
cat00_06 <- tibble(nuts_id = cat00_06) |> 
  mutate(objective_code = 1)

# Which of these regions is not present in the dataset due to NUTS discrepancies
missing_regions <- anti_join(cat00_06, data, by = c("nuts_id" = "NUTS2_ID"))

# Regions which I have deleted because I couldn't use their data
deleted_regions <- c("FR91", "UKI1", "UKI2", "UKZZ", "IE01", "IE02", 
                     "LT00", "HU10", "PL12", "UKM2", "UKM3", "HR04")

# Regions that I should try to identify
missing_regions <- missing_regions |> 
  filter(!nuts_id %in% deleted_regions)
missing_regions

# These are all regions which have undergone only code name changes or minor reshuffling 
cat00_06 <- cat00_06 |> 
  mutate(nuts_id = case_when(
    # DE40 was created by merging DE41 (poor), and DE42 (poor)
    # So I'll consider it poor and I'll convert one of their code into DE40 in here
    # and then deleting the other below
    nuts_id == "DE41" ~ "DE40",
    nuts_id == "DED1" ~ "DED4",
    nuts_id == "DED3" ~ "DED5",
    # DEE0 was created by merging DEE1 (poor), DEE2 (poor), DEE3 (poor)
    # So I'll consider it poor and I'll convert one of their code into DE00 in here
    # and then deleting the other below
    nuts_id == "DEE1" ~ "DEE0",
    nuts_id == "GR11" ~ "EL51",
    nuts_id == "GR12" ~ "EL52",
    nuts_id == "GR13" ~ "EL53",
    nuts_id == "GR14" ~ "EL61",
    nuts_id == "GR21" ~ "EL54",
    nuts_id == "GR22" ~ "EL62",
    nuts_id == "GR23" ~ "EL63",
    nuts_id == "GR24" ~ "EL64",
    nuts_id == "GR25" ~ "EL65",
    nuts_id == "GR30" ~ "EL30",
    nuts_id == "GR41" ~ "EL41",
    nuts_id == "GR42" ~ "EL42",
    nuts_id == "GR43" ~ "EL43",
    nuts_id == "FR92" ~ "FRY2",
    nuts_id == "FR93" ~ "FRY3",
    nuts_id == "FR94" ~ "FRY4",
    nuts_id == "PL11" ~ "PL71",
    nuts_id == "PL31" ~ "PL81",
    nuts_id == "PL32" ~ "PL82",
    nuts_id == "PL33" ~ "PL72",
    nuts_id == "PL34" ~ "PL84",
    # FI1D was created by merging FI13 (poor), FI1A (poor)
    # So I'll consider it poor and I'll convert one of their code into FI1D in here
    # and then deleting the other below
    nuts_id == "FI13" ~ "FI1D",
    nuts_id == "SE06" ~ "SE31",
    nuts_id == "SE07" ~ "SE32",
    nuts_id == "SE08" ~ "SE33",
    nuts_id == "UKD5" ~ "UKD7",
    TRUE ~ nuts_id
  )) |> 
  filter(nuts_id != "DE42") |> 
  filter(nuts_id != "DEE3") |>
  filter(nuts_id != "DEE2") |>
  filter(nuts_id != "FI1A") |> 
  # Slovenia SI00 was split into SI01 and SI02 which are then recoded as SI03 and SI04
  # So I need to add those two lines
  filter(nuts_id != "SI00") |>
  rbind(c("SI03", 1)) |>
  rbind(c("SI04", 1))

anti_join(cat00_06, data, by = c("nuts_id" = "NUTS2_ID"))
```

```{r}
data <- data |> 
  left_join(cat00_06, by = c("NUTS2_ID" = "nuts_id")) |> 
  rename(poor00_06 = objective_code) |> 
  mutate(poor00_06 = case_when(
    Year >= 2000 & Year <=2006 & is.na(poor00_06) ~ 0,
    Year >= 2000 & Year <=2006 & poor00_06 == 1 ~ 1,
    Year < 2000 ~ NA,
    Year > 2006 ~ NA,
  ))
```


# Getting ready for regressions

```{r}
plot_intro(data)
plot_missing(data)
str(data)
```

I have few missing data.

```{r}
data <- data |> 
  mutate(across(starts_with("expenditure"), ~ .x/population)) |> 
  mutate(unemployment = ((unemployment* 1000)/population)*1000) |> 
  mutate(investment = (investment*1000000/population)) |> 
  arrange(NUTS2_ID, Year)
# Now I have:
# 1) expenditure per capita
# 2) number of unemployed per 1000 people
# 3) GDP per capita
# 4) % of people with tertiary education
# 4) investment per capita
# 5) binary for poor regions

data <- data |>
  select(-population)
```

Creating dataframe with growth rate of unemployment

```{r}
data_gr <- data |> 
  arrange(NUTS2_ID, Year) |> 
  group_by(NUTS2_ID) |> 
  mutate(
    unemployment = case_when(
      lag(Year) == Year - 1 ~ (unemployment - lag(unemployment)) / lag(unemployment) * 100, TRUE ~ NA),
    gdp = case_when(
      lag(Year) == Year - 1 ~ (gdp - lag(gdp)) / lag(gdp) * 100,
      TRUE ~ NA),
    investment = case_when(
      lag(Year) == Year - 1 ~ (investment - lag(investment)) / lag(investment) * 100,
      TRUE ~ NA),
    education = case_when(
      lag(Year) == Year - 1 ~ (education - lag(education)) / lag(education) * 100,
      TRUE ~ NA)) |> 
  ungroup()

data_allgr <- data |> 
  arrange(NUTS2_ID, Year) |> 
  group_by(NUTS2_ID) |> 
  mutate(
    unemployment = case_when(
      lag(Year) == Year - 1 ~ (unemployment - lag(unemployment)) / lag(unemployment) * 100,
      TRUE ~ NA),
    gdp = case_when(
      lag(Year) == Year - 1 ~ (gdp - lag(gdp)) / lag(gdp) * 100,
      TRUE ~ NA),
    investment = case_when(
      lag(Year) == Year - 1 ~ (investment - lag(investment)) / lag(investment) * 100,
      TRUE ~ NA),
    education = case_when(
      lag(Year) == Year - 1 ~ (education - lag(education)) / lag(education) * 100,
      TRUE ~ NA),
    across(
      .cols = starts_with("expenditure"),
      .fns = ~ case_when(
        lag(Year) == Year - 1 & lag(.x) != 0 ~ (.x - lag(.x)) / lag(.x) * 100,
        TRUE ~ NA))
    ) |> 
  ungroup()

plot_missing(data)
plot_missing(data_gr)
plot_missing(data_allgr)
```

Lagged expenditure datasets

```{r}
lagged_expenditure <- data |> 
  group_by(NUTS2_ID) %>%
  mutate(across(starts_with("expenditure"), 
                ~lag(., 1),
                .names = "{.col}_lag1")) |> 
  mutate(across(starts_with("expenditure") & !ends_with("lag1"),
                ~lag(., 3),
                .names = "{.col}_lag3")) |>
  mutate(across(starts_with("expenditure") & !ends_with("lag1") & !ends_with("lag3"),
                ~lag(., 5),
                .names = "{.col}_lag5")) |> 
  ungroup()

lagged_expenditure_gr <- data_gr |> 
  group_by(NUTS2_ID) %>%
  mutate(across(starts_with("expenditure"), 
                ~lag(., 1),
                .names = "{.col}_lag1")) |> 
  mutate(across(starts_with("expenditure") & !ends_with("lag1"),
                ~lag(., 3),
                .names = "{.col}_lag3")) |>
  mutate(across(starts_with("expenditure") & !ends_with("lag1") & !ends_with("lag3"),
                ~lag(., 5),
                .names = "{.col}_lag5")) |>
  ungroup()

lagged_expenditure_allgr <- data_allgr |> 
  group_by(NUTS2_ID) %>%
  mutate(across(starts_with("expenditure"), 
                ~lag(., 1),
                .names = "{.col}_lag1")) |> 
  mutate(across(starts_with("expenditure") & !ends_with("lag1"),
                ~lag(., 3),
                .names = "{.col}_lag3")) |>
  mutate(across(starts_with("expenditure") & !ends_with("lag1") & !ends_with("lag3"),
                ~lag(., 5),
                .names = "{.col}_lag5")) |> 
  ungroup()

lagged_exp_1 <- lagged_expenditure |> 
  select(-c(`expenditure_1994-1999_budget`, 
            `expenditure_2000-2006_budget`, 
            `expenditure_2007-2013_budget`, 
            `expenditure_2014-2020_budget`,
            `expenditure_1994-1999_budget_lag3`, 
            `expenditure_2000-2006_budget_lag3`, 
            `expenditure_2007-2013_budget_lag3`, 
            `expenditure_2014-2020_budget_lag3`,
            `expenditure_1994-1999_budget_lag5`, 
            `expenditure_2000-2006_budget_lag5`, 
            `expenditure_2007-2013_budget_lag5`, 
            `expenditure_2014-2020_budget_lag5`))

lagged_exp_3 <- lagged_expenditure |> 
  select(-c(`expenditure_1994-1999_budget`, 
            `expenditure_2000-2006_budget`, 
            `expenditure_2007-2013_budget`, 
            `expenditure_2014-2020_budget`,
            `expenditure_1994-1999_budget_lag1`, 
            `expenditure_2000-2006_budget_lag1`, 
            `expenditure_2007-2013_budget_lag1`, 
            `expenditure_2014-2020_budget_lag1`,
            `expenditure_1994-1999_budget_lag5`, 
            `expenditure_2000-2006_budget_lag5`, 
            `expenditure_2007-2013_budget_lag5`, 
            `expenditure_2014-2020_budget_lag5`))

lagged_exp_5 <- lagged_expenditure |> 
  select(-c(`expenditure_1994-1999_budget`, 
            `expenditure_2000-2006_budget`, 
            `expenditure_2007-2013_budget`, 
            `expenditure_2014-2020_budget`,
            `expenditure_1994-1999_budget_lag1`, 
            `expenditure_2000-2006_budget_lag1`, 
            `expenditure_2007-2013_budget_lag1`, 
            `expenditure_2014-2020_budget_lag1`,
            `expenditure_1994-1999_budget_lag3`, 
            `expenditure_2000-2006_budget_lag3`, 
            `expenditure_2007-2013_budget_lag3`, 
            `expenditure_2014-2020_budget_lag3`))

lagged_exp_1_gr <- lagged_expenditure_gr |> 
  select(-c(`expenditure_1994-1999_budget`, 
            `expenditure_2000-2006_budget`, 
            `expenditure_2007-2013_budget`, 
            `expenditure_2014-2020_budget`,
            `expenditure_1994-1999_budget_lag3`, 
            `expenditure_2000-2006_budget_lag3`, 
            `expenditure_2007-2013_budget_lag3`, 
            `expenditure_2014-2020_budget_lag3`,
            `expenditure_1994-1999_budget_lag5`, 
            `expenditure_2000-2006_budget_lag5`, 
            `expenditure_2007-2013_budget_lag5`, 
            `expenditure_2014-2020_budget_lag5`))

lagged_exp_3_gr <- lagged_expenditure_gr |> 
  select(-c(`expenditure_1994-1999_budget`, 
            `expenditure_2000-2006_budget`, 
            `expenditure_2007-2013_budget`, 
            `expenditure_2014-2020_budget`,
            `expenditure_1994-1999_budget_lag1`, 
            `expenditure_2000-2006_budget_lag1`, 
            `expenditure_2007-2013_budget_lag1`, 
            `expenditure_2014-2020_budget_lag1`,
            `expenditure_1994-1999_budget_lag5`, 
            `expenditure_2000-2006_budget_lag5`, 
            `expenditure_2007-2013_budget_lag5`, 
            `expenditure_2014-2020_budget_lag5`))

lagged_exp_5_gr <- lagged_expenditure_gr |> 
  select(-c(`expenditure_1994-1999_budget`, 
            `expenditure_2000-2006_budget`, 
            `expenditure_2007-2013_budget`, 
            `expenditure_2014-2020_budget`,
            `expenditure_1994-1999_budget_lag1`, 
            `expenditure_2000-2006_budget_lag1`, 
            `expenditure_2007-2013_budget_lag1`, 
            `expenditure_2014-2020_budget_lag1`,
            `expenditure_1994-1999_budget_lag3`, 
            `expenditure_2000-2006_budget_lag3`, 
            `expenditure_2007-2013_budget_lag3`, 
            `expenditure_2014-2020_budget_lag3`))

lagged_exp_1_allgr <- lagged_expenditure_allgr |> 
  select(-c(`expenditure_1994-1999_budget`, 
            `expenditure_2000-2006_budget`, 
            `expenditure_2007-2013_budget`, 
            `expenditure_2014-2020_budget`,
            `expenditure_1994-1999_budget_lag3`, 
            `expenditure_2000-2006_budget_lag3`, 
            `expenditure_2007-2013_budget_lag3`, 
            `expenditure_2014-2020_budget_lag3`,
            `expenditure_1994-1999_budget_lag5`, 
            `expenditure_2000-2006_budget_lag5`, 
            `expenditure_2007-2013_budget_lag5`, 
            `expenditure_2014-2020_budget_lag5`))

lagged_exp_3_allgr <- lagged_expenditure_allgr |> 
  select(-c(`expenditure_1994-1999_budget`, 
            `expenditure_2000-2006_budget`, 
            `expenditure_2007-2013_budget`, 
            `expenditure_2014-2020_budget`,
            `expenditure_1994-1999_budget_lag1`, 
            `expenditure_2000-2006_budget_lag1`, 
            `expenditure_2007-2013_budget_lag1`, 
            `expenditure_2014-2020_budget_lag1`,
            `expenditure_1994-1999_budget_lag5`, 
            `expenditure_2000-2006_budget_lag5`, 
            `expenditure_2007-2013_budget_lag5`, 
            `expenditure_2014-2020_budget_lag5`))

lagged_exp_5_allgr <- lagged_expenditure_allgr |> 
  select(-c(`expenditure_1994-1999_budget`, 
            `expenditure_2000-2006_budget`, 
            `expenditure_2007-2013_budget`, 
            `expenditure_2014-2020_budget`,
            `expenditure_1994-1999_budget_lag1`, 
            `expenditure_2000-2006_budget_lag1`, 
            `expenditure_2007-2013_budget_lag1`, 
            `expenditure_2014-2020_budget_lag1`,
            `expenditure_1994-1999_budget_lag3`, 
            `expenditure_2000-2006_budget_lag3`, 
            `expenditure_2007-2013_budget_lag3`, 
            `expenditure_2014-2020_budget_lag3`))
```

Autoregressive datasets

```{r}
auto <- data |> 
  group_by(NUTS2_ID) |> 
  mutate(lag_unemployment = lag(unemployment, 1)) |> 
  ungroup()

auto_gr <- data_gr |> 
  group_by(NUTS2_ID) |> 
  mutate(lag_unemployment = lag(unemployment, 1)) |> 
  ungroup()

auto_allgr <- data_allgr |> 
  group_by(NUTS2_ID) |> 
  mutate(lag_unemployment = lag(unemployment, 1)) |> 
  ungroup()
```

Autoregressive with lagged expenditure

```{r}
lagged <- data |> 
  group_by(NUTS2_ID) |> 
  mutate(lag_unemployment = lag(unemployment, 1)) |> 
  mutate(across(starts_with("expenditure"), 
                ~lag(., 1),
                .names = "{.col}_lag1")) |> 
  mutate(across(starts_with("expenditure") & !ends_with("lag1"),
                ~lag(., 3),
                .names = "{.col}_lag3")) |>
  mutate(across(starts_with("expenditure") & !ends_with("lag1") & !ends_with("lag3"),
                ~lag(., 5),
                .names = "{.col}_lag5")) |> 
  ungroup()

lagged_gr <- data_gr |> 
  group_by(NUTS2_ID) |> 
  mutate(lag_unemployment = lag(unemployment, 1)) |> 
  mutate(across(starts_with("expenditure"), 
                ~lag(., 1),
                .names = "{.col}_lag1")) |> 
  mutate(across(starts_with("expenditure") & !ends_with("lag1"),
                ~lag(., 3),
                .names = "{.col}_lag3")) |>
  mutate(across(starts_with("expenditure") & !ends_with("lag1") & !ends_with("lag3"),
                ~lag(., 5),
                .names = "{.col}_lag5")) |> 
  ungroup()

lagged_allgr <- data_allgr |> 
  group_by(NUTS2_ID) |> 
  mutate(lag_unemployment = lag(unemployment, 1)) |> 
  mutate(across(starts_with("expenditure"), 
                ~lag(., 1),
                .names = "{.col}_lag1")) |> 
  mutate(across(starts_with("expenditure") & !ends_with("lag1"),
                ~lag(., 3),
                .names = "{.col}_lag3")) |>
  mutate(across(starts_with("expenditure") & !ends_with("lag1") & !ends_with("lag3"),
                ~lag(., 5),
                .names = "{.col}_lag5")) |> 
  ungroup()
```

Growth rates over long period of time

```{r}
gr_3 <- data |> 
  group_by(NUTS2_ID) |> 
  mutate(
    gdp = (gdp - lag(gdp, 2)) / lag(gdp, 2) * 100,
    unemployment = (unemployment - lag(unemployment, 2)) / lag(unemployment, 2) * 100
  ) |> 
  mutate(across(
    starts_with("expenditure"),
    ~ lag(., 2),
    .names = "{.col}_lag2"
  )) |>
  mutate(across(
    starts_with("expenditure") & !ends_with("lag2"),
    ~ slide_dbl(., ~ if (all(is.na(.x))) NA else sum(.x, na.rm = TRUE), .before = 2),
    .names = "{.col}_rollsum3"
  )) |>
  mutate(across(
    starts_with("expenditure") & !ends_with("lag2") & !ends_with("rollsum3"),
    ~ slide_dbl(., ~ mean(.x, na.rm = TRUE), .before = 2, .complete = FALSE),
    .names = "{.col}_rollmean3"
  )) |>
  ungroup()
  
gr_5 <- data |> 
  group_by(NUTS2_ID) |> 
  mutate(gdp = (gdp - lag(gdp, 4)) / lag(gdp, 4) * 100,
         unemployment = (unemployment - lag(unemployment, 4)) / lag(unemployment, 4) * 100) |> 
  mutate(across(starts_with("expenditure"),
                ~lag(., 4),
                .names = "{.col}_lag4")) |>
  mutate(across(
    starts_with("expenditure") & !ends_with("lag4"),
    ~ slide_dbl(., ~ if (all(is.na(.x))) NA else sum(.x, na.rm = TRUE), .before = 4),
    .names = "{.col}_rollsum5"
  )) |>
  mutate(across(
    starts_with("expenditure") & !ends_with("lag4") & !ends_with("rollsum5"),
    ~ slide_dbl(., ~ mean(.x, na.rm = TRUE), .before = 4, .complete = FALSE),
    .names = "{.col}_rollmean5"
  )) |>
  ungroup() 

gr_7 <- data |> 
  group_by(NUTS2_ID) |> 
  mutate(gdp = (gdp - lag(gdp, 6)) / lag(gdp, 6) * 100,
         unemployment = (unemployment - lag(unemployment, 6)) / lag(unemployment, 6) * 100) |> 
  mutate(across(starts_with("expenditure"),
                ~lag(., 6),
                .names = "{.col}_lag6")) |>
  mutate(across(
    starts_with("expenditure") & !ends_with("lag6"),
    ~ slide_dbl(., ~ if (all(is.na(.x))) NA else sum(.x, na.rm = TRUE), .before = 6),
    .names = "{.col}_rollsum7"
  )) |>
  mutate(across(
    starts_with("expenditure") & !ends_with("lag6") & !ends_with("rollsum7"),
    ~ slide_dbl(., ~ mean(.x, na.rm = TRUE), .before = 6, .complete = FALSE),
    .names = "{.col}_rollmean7"
  )) |>
  ungroup() 
```

Averages

```{r}
avg_3 <- data |> 
  group_by(NUTS2_ID) |> 
  mutate(
    gdp = slider::slide_dbl(gdp, ~mean(.x, na.rm = TRUE), 
                            .before = 2, .complete = FALSE),
    unemployment = slider::slide_dbl(unemployment, ~mean(.x, na.rm = TRUE), 
                                     .before = 2, .complete = FALSE),
    investment = slider::slide_dbl(investment, ~mean(.x, na.rm = TRUE), 
                                     .before = 4, .complete = FALSE),
    across(
      starts_with("expenditure"),
      ~ slider::slide_dbl(.x, ~mean(.x, na.rm = TRUE), 
                          .before = 2, .complete = FALSE),
      .names = "{.col}_avg3"
    )
  ) |> 
  ungroup()

  
avg_5 <- data |> 
  group_by(NUTS2_ID) |> 
  mutate(
    gdp = slider::slide_dbl(gdp, ~mean(.x, na.rm = TRUE), 
                            .before = 4, .complete = FALSE),
    unemployment = slider::slide_dbl(unemployment, ~mean(.x, na.rm = TRUE), 
                                     .before = 4, .complete = FALSE),
    investment = slider::slide_dbl(investment, ~mean(.x, na.rm = TRUE), 
                                     .before = 4, .complete = FALSE),
    across(
      starts_with("expenditure"),
      ~ slider::slide_dbl(.x, ~mean(.x, na.rm = TRUE), 
                          .before = 4, .complete = FALSE),
      .names = "{.col}_avg5"
    )
  ) |> 
  ungroup() 

avg_7 <- data |> 
  group_by(NUTS2_ID) |> 
  mutate(
    gdp = slider::slide_dbl(gdp, ~mean(.x, na.rm = TRUE), 
                            .before = 6, .complete = FALSE),
    unemployment = slider::slide_dbl(unemployment, ~mean(.x, na.rm = TRUE), 
                                     .before = 6, .complete = FALSE),
    investment = slider::slide_dbl(investment, ~mean(.x, na.rm = TRUE), 
                                     .before = 4, .complete = FALSE),
    across(
      starts_with("expenditure"),
      ~ slider::slide_dbl(.x, ~mean(.x, na.rm = TRUE), 
                          .before = 6, .complete = FALSE),
      .names = "{.col}_avg7"
    )
  ) |> 
  ungroup()


avg_gr3 <- data_gr |> 
  group_by(NUTS2_ID) |> 
  mutate(
    gdp = slider::slide_dbl(gdp, ~mean(.x, na.rm = TRUE), 
                            .before = 2, .complete = FALSE),
    unemployment = slider::slide_dbl(unemployment, ~mean(.x, na.rm = TRUE), 
                                     .before = 2, .complete = FALSE),
    investment = slider::slide_dbl(investment, ~mean(.x, na.rm = TRUE), 
                                     .before = 4, .complete = FALSE),
    across(
      starts_with("expenditure"),
      ~ slider::slide_dbl(.x, ~mean(.x, na.rm = TRUE), 
                          .before = 2, .complete = FALSE),
      .names = "{.col}_avg3"
    )
  ) |> 
  ungroup()

  
avg_gr5 <- data_gr |> 
  group_by(NUTS2_ID) |> 
  mutate(
    gdp = slider::slide_dbl(gdp, ~mean(.x, na.rm = TRUE), 
                            .before = 4, .complete = FALSE),
    unemployment = slider::slide_dbl(unemployment, ~mean(.x, na.rm = TRUE), 
                                     .before = 4, .complete = FALSE),
    investment = slider::slide_dbl(investment, ~mean(.x, na.rm = TRUE), 
                                     .before = 4, .complete = FALSE),
    across(
      starts_with("expenditure"),
      ~ slider::slide_dbl(.x, ~mean(.x, na.rm = TRUE), 
                          .before = 4, .complete = FALSE),
      .names = "{.col}_avg5"
    )
  ) |> 
  ungroup() 

avg_gr7 <- data_gr |> 
  group_by(NUTS2_ID) |> 
  mutate(
    gdp = slider::slide_dbl(gdp, ~mean(.x, na.rm = TRUE), 
                            .before = 6, .complete = FALSE),
    unemployment = slider::slide_dbl(unemployment, ~mean(.x, na.rm = TRUE), 
                                     .before = 6, .complete = FALSE),
    investment = slider::slide_dbl(investment, ~mean(.x, na.rm = TRUE), 
                                     .before = 4, .complete = FALSE),
    across(
      starts_with("expenditure"),
      ~ slider::slide_dbl(.x, ~mean(.x, na.rm = TRUE), 
                          .before = 6, .complete = FALSE),
      .names = "{.col}_avg7"
    )
  ) |> 
  ungroup()
```

GDP

```{r}
gr_gdp <- data |>
  arrange(NUTS2_ID, Year) |> 
  group_by(NUTS2_ID) |> 
  mutate(gdp = (gdp - lag(gdp, 1)) / lag(gdp, 1) * 100)|>
  mutate(unemployment = (unemployment - lag(unemployment, 1)) / lag(unemployment, 1) * 100)|>
  mutate(investment = (investment - lag(investment, 1)) / lag(investment, 1) * 100)|>
  ungroup()

lag1_gr_gdp <- data |>
  arrange(NUTS2_ID, Year) |> 
  group_by(NUTS2_ID) |> 
  mutate(gdp = (gdp - lag(gdp, 1)) / lag(gdp, 1) * 100) |>
  mutate(lag_gdp = lag(gdp)) |> 
  mutate(unemployment = (unemployment - lag(unemployment, 1)) / lag(unemployment, 1) * 100)|>
  mutate(across(starts_with("expenditure"),
                ~lag(., 1),
                .names = "{.col}_lag1")) |> 
  ungroup()

lag3_gr_gdp <- data |>
  arrange(NUTS2_ID, Year) |> 
  group_by(NUTS2_ID) |> 
  mutate(gdp = (gdp - lag(gdp, 1)) / lag(gdp, 1) * 100) |>
  mutate(lag_gdp = lag(gdp)) |> 
  mutate(unemployment = (unemployment - lag(unemployment, 1)) / lag(unemployment, 1) * 100)|>
  mutate(across(starts_with("expenditure"),
                ~lag(., 3),
                .names = "{.col}_lag3")) |> 
  ungroup()

lag5_gr_gdp <- data |>
  arrange(NUTS2_ID, Year) |> 
  group_by(NUTS2_ID) |> 
  mutate(gdp = (gdp - lag(gdp, 1)) / lag(gdp, 1) * 100) |>
  mutate(lag_gdp = lag(gdp)) |> 
  mutate(unemployment = (unemployment - lag(unemployment, 1)) / lag(unemployment, 1) * 100)|>
  mutate(across(starts_with("expenditure"),
                ~lag(., 5),
                .names = "{.col}_lag5")) |> 
  ungroup()
```

Filtering out rows with missing values for our dependent variable. R does complete case analysis when running regressions so it eliminates observations with missing values. Here I eliminate only rows with missing values in the dependent variable as those observations will never be useful in any of the models I try below (while I do not eliminate the rest as they could be useful in models where I use only covariates or only expenditure or etc.)

```{r}
data <- data |>
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

data_gr <- data_gr |>
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

data_allgr <- data_allgr |>
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2001)

lagged_exp_1 <- lagged_exp_1 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lagged_exp_3 <- lagged_exp_3 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lagged_exp_5 <- lagged_exp_5 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lagged_exp_1_gr <- lagged_exp_1_gr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lagged_exp_3_gr <- lagged_exp_3_gr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lagged_exp_5_gr <- lagged_exp_5_gr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lagged_exp_1_allgr <- lagged_exp_1_allgr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2001)

lagged_exp_3_allgr <- lagged_exp_3_allgr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2001)

lagged_exp_5_allgr <- lagged_exp_5_allgr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2001)

auto <- auto |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

auto_gr <- auto_gr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

auto_allgr <- auto_allgr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2001)

lagged <- lagged |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lagged_gr <- lagged_gr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lagged_allgr <- lagged_allgr |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2001)

gr_3 <- gr_3 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

gr_5 <- gr_5 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

gr_7 <- gr_7 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2001)

avg_3 <- avg_3 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

avg_5 <- avg_5 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

avg_7 <- avg_7 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

avg_gr3 <- avg_gr3 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

avg_gr5 <- avg_gr5 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

avg_gr7 <- avg_gr7 |> 
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)
```

Splitting into 1 dataframe per year

1) Absolute values

```{r}
# List of dataframes 1 per year
list_data <- split(data, data$Year)

#  Removing columns with all NAs (i.e. Keeping only the relevant budget cycle columns for each year)
list_data_cleaned <- map(list_data, ~ .x[, colSums(!is.na(.x)) > 0])

# Keeping only the numeric variables for regression 
list_data_cleaned <- map(list_data_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))
```

2) Growth rate of unemployment

```{r}
# List of dataframes 1 per year
list_data_gr <- split(data_gr, data_gr$Year)

#  Removing columns with all NAs (i.e. Keeping only the relevant budget cycle columns for each year)
list_data_gr_cleaned <- map(list_data_gr, ~ .x[, colSums(!is.na(.x)) > 0])

# Keeping only the numeric variables for regression 
list_data_gr_cleaned <- map(list_data_gr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))
```

3) All growth rates

```{r}
# List of dataframes 1 per year
list_data_allgr <- split(data_allgr, data_allgr$Year)

#  Removing columns with all NAs (i.e. Keeping only the relevant budget cycle columns for each year)
list_data_allgr_cleaned <- map(list_data_allgr, ~ .x[, colSums(!is.na(.x)) > 0])

# Keeping only the numeric variables for regression 
list_data_allgr_cleaned <- map(list_data_allgr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))
```

4) Lagged expenditure dataset

```{r}
list_lagged_exp1 <- split(lagged_exp_1, lagged_exp_1$Year)
list_lagged_exp1_cleaned <- map(list_lagged_exp1, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_exp1_cleaned <- map(list_lagged_exp1_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_exp3 <- split(lagged_exp_3, lagged_exp_3$Year)
list_lagged_exp3_cleaned <- map(list_lagged_exp3, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_exp3_cleaned <- map(list_lagged_exp3_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_exp5 <- split(lagged_exp_5, lagged_exp_5$Year)
list_lagged_exp5_cleaned <- map(list_lagged_exp5, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_exp5_cleaned <- map(list_lagged_exp5_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_exp1_gr <- split(lagged_exp_1_gr, lagged_exp_1_gr$Year)
list_lagged_exp1_gr_cleaned <- map(list_lagged_exp1_gr, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_exp1_gr_cleaned <- map(list_lagged_exp1_gr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_exp3_gr <- split(lagged_exp_3_gr, lagged_exp_3_gr$Year)
list_lagged_exp3_gr_cleaned <- map(list_lagged_exp3_gr, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_exp3_gr_cleaned <- map(list_lagged_exp3_gr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_exp5_gr <- split(lagged_exp_5_gr, lagged_exp_5_gr$Year)
list_lagged_exp5_gr_cleaned <- map(list_lagged_exp5_gr, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_exp5_gr_cleaned <- map(list_lagged_exp5_gr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_exp1_allgr <- split(lagged_exp_1_allgr, lagged_exp_1_allgr$Year)
list_lagged_exp1_allgr_cleaned <- map(list_lagged_exp1_allgr, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_exp1_allgr_cleaned <- map(list_lagged_exp1_allgr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_exp3_allgr <- split(lagged_exp_3_allgr, lagged_exp_3_allgr$Year)
list_lagged_exp3_allgr_cleaned <- map(list_lagged_exp3_allgr, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_exp3_allgr_cleaned <- map(list_lagged_exp3_allgr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_exp5_allgr <- split(lagged_exp_5_allgr, lagged_exp_5_allgr$Year)
list_lagged_exp5_allgr_cleaned <- map(list_lagged_exp5_allgr, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_exp5_allgr_cleaned <- map(list_lagged_exp5_allgr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))
```

5) Autoregressive datasets

```{r}
list_auto <- split(auto, auto$Year)
list_auto_cleaned <- map(list_auto, ~ .x[, colSums(!is.na(.x)) > 0])
list_auto_cleaned <- map(list_auto_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_auto_gr <- split(auto_gr, auto_gr$Year)
list_auto_gr_cleaned <- map(list_auto_gr, ~ .x[, colSums(!is.na(.x)) > 0])
list_auto_gr_cleaned <- map(list_auto_gr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_auto_allgr <- split(auto_allgr, auto_allgr$Year)
list_auto_allgr_cleaned <- map(list_auto_allgr, ~ .x[, colSums(!is.na(.x)) > 0])
list_auto_allgr_cleaned <- map(list_auto_allgr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))
```

6) Autoregressive with lagged expenditure

```{r}
list_lagged <- split(lagged, lagged$Year)
list_lagged_cleaned <- map(list_lagged, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_cleaned <- map(list_lagged_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_gr <- split(lagged_gr, lagged_gr$Year)
list_lagged_gr_cleaned <- map(list_lagged_gr, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_gr_cleaned <- map(list_lagged_gr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lagged_allgr <- split(lagged_allgr, lagged_allgr$Year)
list_lagged_allgr_cleaned <- map(list_lagged_allgr, ~ .x[, colSums(!is.na(.x)) > 0])
list_lagged_allgr_cleaned <- map(list_lagged_allgr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))
```

7) Growth rates over long period of time

```{r}
list_gr3 <- split(gr_3, gr_3$Year)
list_gr3_cleaned <- map(list_gr3, ~ .x[, colSums(!is.na(.x)) > 0])
list_gr3_cleaned <- map(list_gr3_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_gr5 <- split(gr_5, gr_5$Year)
list_gr5_cleaned <- map(list_gr5, ~ .x[, colSums(!is.na(.x)) > 0])
list_gr5_cleaned <- map(list_gr5_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_gr7 <- split(gr_7, gr_7$Year)
list_gr7_cleaned <- map(list_gr7, ~ .x[, colSums(!is.na(.x)) > 0])
list_gr7_cleaned <- map(list_gr7_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))
```

8) Averages over long period of time

```{r}
list_avg3 <- split(avg_3, avg_3$Year)
list_avg3_cleaned <- map(list_avg3, ~ .x[, colSums(!is.na(.x)) > 0])
list_avg3_cleaned <- map(list_avg3_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_avg5 <- split(avg_5, avg_5$Year)
list_avg5_cleaned <- map(list_avg5, ~ .x[, colSums(!is.na(.x)) > 0])
list_avg5_cleaned <- map(list_avg5_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_avg7 <- split(avg_7, avg_7$Year)
list_avg7_cleaned <- map(list_avg7, ~ .x[, colSums(!is.na(.x)) > 0])
list_avg7_cleaned <- map(list_avg7_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_avg3gr <- split(avg_gr3, avg_gr3$Year)
list_avg3gr_cleaned <- map(list_avg3gr, ~ .x[, colSums(!is.na(.x)) > 0])
list_avg3gr_cleaned <- map(list_avg3gr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_avg5gr <- split(avg_gr5, avg_gr5$Year)
list_avg5gr_cleaned <- map(list_avg5gr, ~ .x[, colSums(!is.na(.x)) > 0])
list_avg5gr_cleaned <- map(list_avg5gr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_avg7gr <- split(avg_gr7, avg_gr7$Year)
list_avg7gr_cleaned <- map(list_avg7gr, ~ .x[, colSums(!is.na(.x)) > 0])
list_avg7gr_cleaned <- map(list_avg7gr_cleaned, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))
```

9) GDP models

```{r}
gr_gdp <- gr_gdp |>
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

list_gr_gdp <- split(gr_gdp, gr_gdp$Year)
list_gr_gdp <- map(list_gr_gdp, ~ .x[, colSums(!is.na(.x)) > 0])
list_gr_gdp <- map(list_gr_gdp, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

lag1_gr_gdp <- lag1_gr_gdp |>
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lag3_gr_gdp <- lag3_gr_gdp |>
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

lag5_gr_gdp <- lag5_gr_gdp |>
  filter(!is.na(unemployment)) |> 
  filter(Year >= 2000)

list_lag1_gr_gdp <- split(lag1_gr_gdp, lag1_gr_gdp$Year)
list_lag1_gr_gdp <- map(list_lag1_gr_gdp, ~ .x[, colSums(!is.na(.x)) > 0])
list_lag1_gr_gdp <- map(list_lag1_gr_gdp, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lag3_gr_gdp <- split(lag3_gr_gdp, lag3_gr_gdp$Year)
list_lag3_gr_gdp <- map(list_lag3_gr_gdp, ~ .x[, colSums(!is.na(.x)) > 0])
list_lag3_gr_gdp <- map(list_lag3_gr_gdp, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))

list_lag5_gr_gdp <- split(lag5_gr_gdp, lag5_gr_gdp$Year)
list_lag5_gr_gdp <- map(list_lag5_gr_gdp, ~ .x[, colSums(!is.na(.x)) > 0])
list_lag5_gr_gdp <- map(list_lag5_gr_gdp, ~ 
  .x |> 
    select(where(is.numeric)) |> 
    select(-Year))
```

# Models

## 1) Model using absolute value of unemployment

```{r}
regression_ab <- map(list_data_cleaned, ~ lm(unemployment ~ ., data = .x))
names(regression_ab) <- names(list_data_cleaned)
modelsummary(
  models = regression_ab,
  fmt = fmt_decimal(digits = 2),
  stars = TRUE,
  statistic = NULL,
  coef_map = c("gdp", "investment", "education", 
               "expenditure_1994-1999_budget", "expenditure_2000-2006_budget",
               "expenditure_2007-2013_budget", "expenditure_2014-2020_budget",
               "poor00_06", "poor07_13", "poor14_20"),
  gof_map = list(
    list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
    list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
    list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
  output = "ab.md"
)

rsquared <- map_dbl(regression_ab, ~ summary(.x)$r.squared)
ab <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_ab, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_ab, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

ab <- ab |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_education", .after = "education") |>
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# Expected coefficients
# expenditure -> negative
# GDP -> negative
# Education -> negative
# investment -> negative
# poor binaries -> positive

# Mostly positive coefficient for expenditure, sometimes significant, sometimes non-significant
# gdp both positive and negative coefficients, more insignificant than significant
# education is positive, sometimes non-significant
# investment is negative most of the times significant
# poor binaries tend to be significant and positive in the first years, negative in recent years
mean(ab$r_squared)
sum(ab$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(ab$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(ab$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(ab$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(ab$"`expenditure_1994-1999_budget`")) + sum(!is.na(ab$"`expenditure_2000-2006_budget`")) + sum(!is.na(ab$"`expenditure_2007-2013_budget`")) + sum(!is.na(ab$"`expenditure_2014-2020_budget`"))
sum(ab$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(ab$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(ab$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(ab$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```


## 2) Model using growth rates

```{r}
regression_gr <- map(list_data_gr_cleaned, ~ lm(unemployment ~ ., data = .x))
names(regression_gr) <- names(list_data_gr_cleaned)
modelsummary(
  models = regression_gr,
  fmt = fmt_decimal(digits = 2),
  stars = TRUE,
  statistic = NULL,
  coef_map = c("gdp", "investment", "education", 
               "expenditure_1994-1999_budget", "expenditure_2000-2006_budget",
               "expenditure_2007-2013_budget", "expenditure_2014-2020_budget",
               "poor00_06", "poor07_13", "poor14_20"),
  gof_map = list(
    list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
    list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
    list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
  output = "gr.md"
)

rsquared <- map_dbl(regression_gr, ~ summary(.x)$r.squared)
gr <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_gr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_gr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

gr <- gr |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_education", .after = "education") |>
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# Expenditure is almost always insignificant but it tends to be negative for older or more recent years (not in the center)
# gdp most of the times non significant, coefficients both positives and negatives
# education is mostly negative sometimes non significant
# investment is mostly negative and sometimes non-significant
# binaries are primarly negative rairly significant
mean(gr$r_squared)
sum(gr$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(gr$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(gr$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(gr$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(gr$"`expenditure_1994-1999_budget`")) + sum(!is.na(gr$"`expenditure_2000-2006_budget`")) + sum(!is.na(gr$"`expenditure_2007-2013_budget`")) + sum(!is.na(gr$"`expenditure_2014-2020_budget`"))
sum(gr$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(gr$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(gr$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(gr$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

## 3) All growth rates

```{r}
regression_allgr <- map(list_data_allgr_cleaned, ~ lm(unemployment ~ ., data = .x))
names(regression_allgr) <- names(list_data_allgr_cleaned)
modelsummary(
  models = regression_allgr,
  fmt = fmt_decimal(digits = 2),
  stars = TRUE,
  statistic = NULL,
  coef_map = c("gdp", "investment", "education", 
               "expenditure_1994-1999_budget", "expenditure_2000-2006_budget",
               "expenditure_2007-2013_budget", "expenditure_2014-2020_budget",
               "poor00_06", "poor07_13", "poor14_20"),
  gof_map = list(
    list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
    list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
    list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
  output = "allgr.md"
)

rsquared <- map_dbl(regression_allgr, ~ summary(.x)$r.squared)
allgr <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_allgr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_allgr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

allgr <- allgr |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_education", .after = "education") |>
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# expenditure often non significant both negative and positive coefficients
# gdp almost always significant, almost always negative
# education is non significant, coefficients both ways
# investment when significant is negative
# binary poor basically never significant coefficients both ways
mean(allgr$r_squared)
sum(allgr$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(allgr$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(allgr$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(allgr$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(allgr$"`expenditure_1994-1999_budget`")) + sum(!is.na(allgr$"`expenditure_2000-2006_budget`")) + sum(!is.na(allgr$"`expenditure_2007-2013_budget`")) + sum(!is.na(allgr$"`expenditure_2014-2020_budget`"))
sum(allgr$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(allgr$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(allgr$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(allgr$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

## 4) Only controls model

### 4.1 GDP only

#### 4.1.1

```{r}
regression1 <- map(list_data_cleaned, ~ lm(unemployment ~ gdp, data = .x))
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_gdp <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term == "gdp") |> 
  select(year, term, estimate, p.value) |>
  pivot_wider(names_from = term, values_from = estimate)
solo_gdp <- solo_gdp |> 
  left_join(coefficients, by = "year") |> 
  mutate(across(where(is.numeric), ~ round(.x, 6)))
# GDP is constantly significant and negative when predicting absolute unemployment values
solo_gdp |> filter(p.value < 0.1) |> nrow()
mean(solo_gdp$gdp)
mean(solo_gdp$r_squared)
```

#### 4.1.2

```{r}
regression1_gr <- map(list_data_gr_cleaned, ~ lm(unemployment ~ gdp, data = .x))
rsquared <- map_dbl(regression1_gr, ~ summary(.x)$r.squared)
solo_gdp_gr <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1_gr,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term == "gdp") |> 
  select(year, term, estimate, p.value) |>
  pivot_wider(names_from = term, values_from = estimate)
solo_gdp_gr <- solo_gdp_gr |> 
  left_join(coefficients, by = "year") |> 
  mutate(across(where(is.numeric), ~ round(.x, 6)))
# When both are in growth rates gdp is almost always significant and when significant is negative
solo_gdp_gr |> filter(p.value < 0.1) |> nrow()
mean(solo_gdp_gr$gdp)
mean(solo_gdp_gr$r_squared)
```

### 4.2 Investment only

#### 4.2.1

```{r}
regression1 <- map(list_data_cleaned, ~ lm(unemployment ~ investment, data = .x))
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_investment <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term == "investment") |> 
  select(year, term, estimate, p.value) |>
  pivot_wider(names_from = term, values_from = estimate)
solo_investment <- solo_investment |> 
  left_join(coefficients, by = "year") |> 
  mutate(across(where(is.numeric), ~ round(.x, 6)))
# Investment is constantly significant and negative when predicting absolute unemployment values
solo_investment |> filter(p.value < 0.1) |> nrow()
mean(solo_investment$investment)
mean(solo_investment$r_squared)
```

#### 4.2.2

```{r}
regression1_gr <- map(list_data_gr_cleaned, ~ lm(unemployment ~ investment, data = .x))
rsquared <- map_dbl(regression1_gr, ~ summary(.x)$r.squared)
solo_investment_gr <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1_gr,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term == "investment") |> 
  select(year, term, estimate, p.value) |>
  pivot_wider(names_from = term, values_from = estimate)
solo_investment_gr <- solo_investment_gr |> 
  left_join(coefficients, by = "year") |> 
  mutate(across(where(is.numeric), ~ round(.x, 6)))
# When both are in growth rates investment is sometimes significant and mostly negative
solo_investment_gr |> filter(p.value < 0.1) |> nrow()
mean(solo_investment_gr$investment)
mean(solo_investment_gr$r_squared)
```

### 4.3 Education only

#### 4.3.1

```{r}
regression1 <- map(list_data_cleaned, ~ lm(unemployment ~ education, data = .x))
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_education <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term == "education") |> 
  select(year, term, estimate, p.value) |>
  pivot_wider(names_from = term, values_from = estimate)
solo_education <- solo_education |> 
  left_join(coefficients, by = "year") |> 
  mutate(across(where(is.numeric), ~ round(.x, 6)))
# education is rarely significant and mostly negative when predicting absolute unemployment values
solo_education |> filter(p.value < 0.1) |> nrow()
mean(solo_education$education)
mean(solo_education$r_squared)
```

#### 4.3.2

```{r}
regression1_gr <- map(list_data_gr_cleaned[names(list_data_gr_cleaned) != "2000"],
                      ~ lm(unemployment ~ education, data = .x))
rsquared <- map_dbl(regression1_gr, ~ summary(.x)$r.squared)
solo_education_gr <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1_gr,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term == "education") |> 
  select(year, term, estimate, p.value) |>
  pivot_wider(names_from = term, values_from = estimate)
solo_education_gr <- solo_education_gr |> 
  left_join(coefficients, by = "year") |> 
  mutate(across(where(is.numeric), ~ round(.x, 6)))
# When both are in growth rates education is sometimes significant but no consistent sign
solo_education_gr |> filter(p.value < 0.1) |> nrow()
mean(solo_education_gr$education)
mean(solo_education_gr$r_squared)
```

### 4.4 Only poor binaries 

#### 4.4.1

```{r}
regression1 <- map(list_data_cleaned, function(df) {
  # Find column names that start with "poor"
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~", paste(poor_vars, collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")
# when significant (2 periods out of 3) poor is positive
mean(solo_controls$r_squared)
```

#### 4.4.2

```{r}
regression1 <- map(list_data_gr_cleaned, function(df) {
  # Find column names that start with "poor"
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~", paste(poor_vars, collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")
# when significant (50%) usually negative
mean(solo_controls$r_squared)
```

### 4.5 GDP + dummy poor

#### 4.5.1

```{r}
regression1 <- map(list_data_cleaned, function(df) {
  # Find column names that start with "poor"
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +", paste(poor_vars, collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")
# gdp is always negative and most of the times significant
# poor are significant and positive for early 2000, insignificant for middle 2000s, significant and negative for 2010s
mean(solo_controls$r_squared)
```

#### 4.5.2

```{r}
regression1 <- map(list_data_gr_cleaned, function(df) {
  # Find column names that start with "poor"
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +", paste(poor_vars, collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")
#  gdp mostly significant (and negative)
# poor binaries are not often significant and coefficients both positive and negatives
mean(solo_controls$r_squared)
```

### 4.6 GDP+Investment

#### 4.6.1

```{r}
regression1 <- map(list_data_cleaned, ~ lm(unemployment ~ gdp + investment, data = .x))
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment")
# As soon as I put GDP and investment together, gdp looses basically of its significance, investment looses some of its significance
solo_controls |> filter(p.value_gdp < 0.1) |> nrow()
solo_controls |> filter(p.value_investment < 0.1) |> nrow()
mean(solo_controls$r_squared)
```

#### 4.6.2

```{r}
regression1 <- map(list_data_gr_cleaned, ~ lm(unemployment ~ gdp + investment, data = .x))
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment")
# gdp when significant (almost always) is negative
# investment is less significant and coefficeints non consistent
solo_controls |> filter(p.value_gdp < 0.1) |> nrow()
solo_controls |> filter(p.value_investment < 0.1) |> nrow()
mean(solo_controls$r_squared)
```

### 4.7 GDP + investment + poor binaries

#### 4.7.1

```{r}
# Adding poor binaries
regression1 <- map(list_data_cleaned, function(df) {
  # Find column names that start with "poor"
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp + investment +", paste(poor_vars, collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")
# Not much changes putting in also the poor binaries
# investment is predominantly significant, while gdp is rarely significant (a bit more now than before). 
# Poor binaries show their classical behaviors of being positive in the early 2000s and then turning into negative
solo_controls |> filter(p.value_gdp < 0.1) |> nrow()
solo_controls |> filter(p.value_investment < 0.1) |> nrow()
mean(solo_controls$r_squared)
```

#### 4.7.2

```{r}
regression1 <- map(list_data_gr_cleaned, function(df) {
  # Find column names that start with "poor"
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp + investment +", paste(poor_vars, collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")
# gdp often significant (and negative) 
# investment not often significant, but when significant negative
# poor binaries are mostly non significant
solo_controls |> filter(p.value_gdp < 0.1) |> nrow()
solo_controls |> filter(p.value_investment < 0.1) |> nrow()
mean(solo_controls$r_squared)

# poor binaries seem to help only in the absolute model
```

### 4.8 All controls (no expenditure)

#### 4.8.1

```{r}
# Adding also education
regression1 <- map(list_data_cleaned, function(df) {
  # Find column names that start with "poor"
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp + investment + education +", paste(poor_vars, collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_education", .after = "education") |>
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")
# Adding education makes gdp even a bit more significant, while investment looses a bit of significance. 
# Education is mostly significant but with the wrong sign. 
# Poor binaries are primarly significant but their coefficient completely changes from 2010 on
solo_controls |> filter(p.value_gdp < 0.1) |> nrow()
solo_controls |> filter(p.value_investment < 0.1) |> nrow()
solo_controls |> filter(p.value_education < 0.1) |> nrow()
mean(solo_controls$r_squared)
```

#### 4.8.2

```{r}
regression1 <- map(list_data_gr_cleaned[names(list_data_gr_cleaned) != "2000"], function(df) {
  # Find column names that start with "poor"
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp + investment + education +", paste(poor_vars, collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
rsquared <- map_dbl(regression1, ~ summary(.x)$r.squared)
solo_controls <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)
coefficients <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(
  regression1,
  ~ broom::tidy(.x), 
  .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")
solo_controls <- solo_controls |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_education", .after = "education") |>
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")
# education, investment and gdp all are inconsistent in terms of significance and coefficient sign 
# Poor binaries are primarly non-significant and with a negative sign
solo_controls |> filter(p.value_gdp < 0.1) |> nrow()
solo_controls |> filter(p.value_investment < 0.1) |> nrow()
solo_controls |> filter(p.value_education < 0.1) |> nrow()
mean(solo_controls$r_squared)

# education is not adding much
```

## 5) Only expenditure models

```{r}
no_controls <- map(list_data_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_gr <- map(list_data_gr_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_allgr <- map(list_data_allgr_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_lag1 <- map(list_lagged_exp1_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_gr_lag1 <- map(list_lagged_exp1_gr_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_allgr_lag1 <- map(list_lagged_exp1_allgr_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_lag3 <- map(list_lagged_exp3_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_gr_lag3 <- map(list_lagged_exp3_gr_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_allgr_lag3 <- map(list_lagged_exp3_allgr_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_lag5 <- map(list_lagged_exp5_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_gr_lag5 <- map(list_lagged_exp5_gr_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))

no_controls_allgr_lag5 <- map(list_lagged_exp5_allgr_cleaned, ~ .x |>
                     select(starts_with("expenditure"), unemployment))
```

### 5.1 Absolute terms

#### 5.1.1

```{r}
# no lag
regression_nc <- map(no_controls, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`")
# expenditure is almost always significant, but it is positive

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget`"))
sum(nc$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

#### 5.1.2

```{r}
# lagged 1
regression_nc <- map(no_controls_lag1, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag1`", .after = "`expenditure_1994-1999_budget_lag1`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag1`", .after = "`expenditure_2000-2006_budget_lag1`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag1`", .after = "`expenditure_2007-2013_budget_lag1`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag1`", .after = "`expenditure_2014-2020_budget_lag1`")
# expenditure is almost always significant, but it is positive. no changes with before basically

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget_lag1`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget_lag1`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget_lag1`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget_lag1`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget_lag1`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget_lag1`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget_lag1`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget_lag1`"))
sum(nc$"p.value_`expenditure_1994-1999_budget_lag1`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget_lag1`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget_lag1`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget_lag1`" < 0.1, na.rm = TRUE)
```

#### 5.1.3

```{r}
# lagged 3
regression_nc <- map(no_controls_lag3, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag3`", .after = "`expenditure_1994-1999_budget_lag3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag3`", .after = "`expenditure_2000-2006_budget_lag3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag3`", .after = "`expenditure_2007-2013_budget_lag3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag3`", .after = "`expenditure_2014-2020_budget_lag3`")
# expenditure is almost always significant, but it is positive. r-squared a little higher

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget_lag3`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget_lag3`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget_lag3`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget_lag3`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget_lag3`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget_lag3`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget_lag3`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget_lag3`"))
sum(nc$"p.value_`expenditure_1994-1999_budget_lag3`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget_lag3`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget_lag3`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget_lag3`" < 0.1, na.rm = TRUE)
```

#### 5.1.4

```{r}
# lagged 5
regression_nc <- map(no_controls_lag5, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag5`", .after = "`expenditure_1994-1999_budget_lag5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag5`", .after = "`expenditure_2000-2006_budget_lag5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag5`", .after = "`expenditure_2007-2013_budget_lag5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag5`", .after = "`expenditure_2014-2020_budget_lag5`")
# expenditure is almost always significant, but it is positive. r-squared a little higher

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget_lag5`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget_lag5`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget_lag5`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget_lag5`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget_lag5`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget_lag5`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget_lag5`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget_lag5`"))
sum(nc$"p.value_`expenditure_1994-1999_budget_lag5`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget_lag5`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget_lag5`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget_lag5`" < 0.1, na.rm = TRUE)
```

### 5.2 Growth rates

#### 5.2.1

```{r}
# no lag
regression_nc <- map(no_controls_gr, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`")
# expenditure is rarely significant, but mainly negative when using abs expenditure of current year to predict growth rate unemployment

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget`"))
sum(nc$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

#### 5.2.2

```{r}
# lagged 1
regression_nc <- map(no_controls_gr_lag1, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag1`", .after = "`expenditure_1994-1999_budget_lag1`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag1`", .after = "`expenditure_2000-2006_budget_lag1`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag1`", .after = "`expenditure_2007-2013_budget_lag1`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag1`", .after = "`expenditure_2014-2020_budget_lag1`")
# expenditure is rarely significant, often, but not always negative when using abs expenditure of lag-1 to predict growth rate unemployment

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget_lag1`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget_lag1`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget_lag1`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget_lag1`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget_lag1`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget_lag1`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget_lag1`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget_lag1`"))
sum(nc$"p.value_`expenditure_1994-1999_budget_lag1`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget_lag1`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget_lag1`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget_lag1`" < 0.1, na.rm = TRUE)
```

#### 5.2.3

```{r}
# lagged 3
regression_nc <- map(no_controls_gr_lag3, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag3`", .after = "`expenditure_1994-1999_budget_lag3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag3`", .after = "`expenditure_2000-2006_budget_lag3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag3`", .after = "`expenditure_2007-2013_budget_lag3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag3`", .after = "`expenditure_2014-2020_budget_lag3`")
# abs expenditure lag-3 is half of the times significant, coefficients go both ways tho when predicting gr unemployment

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget_lag3`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget_lag3`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget_lag3`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget_lag3`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget_lag3`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget_lag3`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget_lag3`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget_lag3`"))
sum(nc$"p.value_`expenditure_1994-1999_budget_lag3`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget_lag3`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget_lag3`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget_lag3`" < 0.1, na.rm = TRUE)
```

#### 5.2.4

```{r}
# lagged 5
regression_nc <- map(no_controls_gr_lag5, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag5`", .after = "`expenditure_1994-1999_budget_lag5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag5`", .after = "`expenditure_2000-2006_budget_lag5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag5`", .after = "`expenditure_2007-2013_budget_lag5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag5`", .after = "`expenditure_2014-2020_budget_lag5`")
# abs expenditure lag-5 is half of the times significant, coefficients go both ways tho when predicting gr unemployment

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget_lag5`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget_lag5`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget_lag5`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget_lag5`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget_lag5`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget_lag5`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget_lag5`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget_lag5`"))
sum(nc$"p.value_`expenditure_1994-1999_budget_lag5`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget_lag5`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget_lag5`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget_lag5`" < 0.1, na.rm = TRUE)
```

### 5.3 All growth rates

#### 5.3.1

```{r}
# no lag
regression_nc <- map(no_controls_allgr, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`")
# expenditure is most of the times non-significant, but mainly negative when using gr expenditure of current year to predict growth rate unemployment

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget`"))
sum(nc$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

#### 5.3.2

```{r}
# lagged 1
regression_nc <- map(no_controls_allgr_lag1, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag1`", .after = "`expenditure_1994-1999_budget_lag1`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag1`", .after = "`expenditure_2000-2006_budget_lag1`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag1`", .after = "`expenditure_2007-2013_budget_lag1`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag1`", .after = "`expenditure_2014-2020_budget_lag1`")
# expenditure is sometimes significant, coefficients go both ways when using growth rate of expenditure lag-1 to predict growth rate unemployment

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget_lag1`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget_lag1`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget_lag1`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget_lag1`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget_lag1`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget_lag1`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget_lag1`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget_lag1`"))
sum(nc$"p.value_`expenditure_1994-1999_budget_lag1`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget_lag1`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget_lag1`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget_lag1`" < 0.1, na.rm = TRUE)
```

#### 5.3.3

```{r}
# lagged 3
regression_nc <- map(no_controls_allgr_lag3, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag3`", .after = "`expenditure_1994-1999_budget_lag3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag3`", .after = "`expenditure_2000-2006_budget_lag3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag3`", .after = "`expenditure_2007-2013_budget_lag3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag3`", .after = "`expenditure_2014-2020_budget_lag3`")
# gr of expenditure lag-3 is rearely significant, coefficients go both ways tho when predicting gr unemployment

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget_lag3`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget_lag3`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget_lag3`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget_lag3`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget_lag3`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget_lag3`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget_lag3`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget_lag3`"))
sum(nc$"p.value_`expenditure_1994-1999_budget_lag3`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget_lag3`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget_lag3`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget_lag3`" < 0.1, na.rm = TRUE)
```

#### 5.3.4

```{r}
# lagged 5
regression_nc <- map(no_controls_allgr_lag5, ~ lm(unemployment ~ ., data = .x))

rsquared <- map_dbl(regression_nc, ~ summary(.x)$r.squared)
nc <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(
  regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_nc, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

nc <- nc |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag5`", .after = "`expenditure_1994-1999_budget_lag5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag5`", .after = "`expenditure_2000-2006_budget_lag5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag5`", .after = "`expenditure_2007-2013_budget_lag5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag5`", .after = "`expenditure_2014-2020_budget_lag5`")
# gr of expenditure lag-5 is basically never significant, coefficients mainly negative, but still both ways

print(paste("R-squared: ", mean(nc$r_squared)))
sum(nc$"`expenditure_1994-1999_budget_lag5`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2000-2006_budget_lag5`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2007-2013_budget_lag5`" < 0, na.rm = TRUE) + sum(nc$"`expenditure_2014-2020_budget_lag5`" < 0, na.rm = TRUE)
sum(!is.na(nc$"`expenditure_1994-1999_budget_lag5`")) + sum(!is.na(nc$"`expenditure_2000-2006_budget_lag5`")) + sum(!is.na(nc$"`expenditure_2007-2013_budget_lag5`")) + sum(!is.na(nc$"`expenditure_2014-2020_budget_lag5`"))
sum(nc$"p.value_`expenditure_1994-1999_budget_lag5`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2000-2006_budget_lag5`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2007-2013_budget_lag5`" < 0.1, na.rm = TRUE) + sum(nc$"p.value_`expenditure_2014-2020_budget_lag5`" < 0.1, na.rm = TRUE)
```

## 6) Autoregressive model

### 6.1 Absolute terms

### 6.1.1

```{r}
# Absolute terms
regression_auto <- map(list_auto_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))
  
  # poor_vars <- names(df)[startsWith(names(df), "poor")]
  # 
  # # Backtick only the expenditure vars
  # exp_vars_bt <- paste0("`", exp_vars, "`")
  # 
  # # Combine both
  # all_vars <- c(exp_vars_bt, poor_vars)
  # 
  # formula <- as.formula(paste(
  #   "unemployment ~ lag_unemployment +",
  #   paste(all_vars, collapse = " + ")
  # ))
  
  # Run regression
  lm(formula, data = df)
})
modelsummary(
  models = regression_auto,
  fmt = fmt_decimal(digits = 2),
  stars = TRUE,
  statistic = NULL,
  coef_map = c("lag_unemployment",
               "expenditure_1994-1999_budget", "expenditure_2000-2006_budget",
               "expenditure_2007-2013_budget", "expenditure_2014-2020_budget"),
  gof_map = list(
    list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
    list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
    list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
  output = "autoreg_ab.md"
)

rsquared <- map_dbl(regression_auto, ~ summary(.x)$r.squared)
autoreg <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_auto, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_auto, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

autoreg <- autoreg |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  # relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  # relocate("p.value_poor00_06", .after = "poor00_06") |>
  # relocate("p.value_poor07_13", .after = "poor07_13") |>
  # relocate("p.value_poor14_20", .after = "poor14_20") |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment")

# r-squared clearly much higher, with lag unemployment very significant, but expenditure is still rarely significant and positive most of the times 
print(paste("R-squared: ", mean(autoreg$r_squared)))
sum(autoreg$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(autoreg$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(autoreg$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(autoreg$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(autoreg$"`expenditure_1994-1999_budget`")) + sum(!is.na(autoreg$"`expenditure_2000-2006_budget`")) + sum(!is.na(autoreg$"`expenditure_2007-2013_budget`")) + sum(!is.na(autoreg$"`expenditure_2014-2020_budget`"))
sum(autoreg$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(autoreg$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(autoreg$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(autoreg$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

#### 6.1.2

```{r}
# lag-1
regression_lagged <- map(list_lagged_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & 
                          endsWith(names(df), "_lag1")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_lagged, ~ summary(.x)$r.squared)
lagged <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

lagged <- lagged |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment") |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag1`", .after = "`expenditure_1994-1999_budget_lag1`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag1`", .after = "`expenditure_2000-2006_budget_lag1`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag1`", .after = "`expenditure_2007-2013_budget_lag1`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag1`", .after = "`expenditure_2014-2020_budget_lag1`")

# Lag unemployment always significant
# expenditure rarely significant, often positive coefficient
print(paste("R-squared: ", mean(lagged$r_squared)))
sum(lagged$"`expenditure_1994-1999_budget_lag1`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2000-2006_budget_lag1`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2007-2013_budget_lag1`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2014-2020_budget_lag1`" < 0, na.rm = TRUE)
sum(!is.na(lagged$"`expenditure_1994-1999_budget_lag1`")) + sum(!is.na(lagged$"`expenditure_2000-2006_budget_lag1`")) + sum(!is.na(lagged$"`expenditure_2007-2013_budget_lag1`")) + sum(!is.na(lagged$"`expenditure_2014-2020_budget_lag1`"))
sum(lagged$"p.value_`expenditure_1994-1999_budget_lag1`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2000-2006_budget_lag1`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2007-2013_budget_lag1`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2014-2020_budget_lag1`" < 0.1, na.rm = TRUE)
```

#### 6.1.3

```{r}
# lag-3
regression_lagged <- map(list_lagged_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & 
                          endsWith(names(df), "_lag3")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_lagged, ~ summary(.x)$r.squared)
lagged <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

lagged <- lagged |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment") |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag3`", .after = "`expenditure_1994-1999_budget_lag3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag3`", .after = "`expenditure_2000-2006_budget_lag3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag3`", .after = "`expenditure_2007-2013_budget_lag3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag3`", .after = "`expenditure_2014-2020_budget_lag3`")

# Lag unemployment always significant
# expenditure rarely significant, often positive coefficient
print(paste("R-squared: ", mean(lagged$r_squared)))
sum(lagged$"`expenditure_1994-1999_budget_lag3`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2000-2006_budget_lag3`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2007-2013_budget_lag3`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2014-2020_budget_lag3`" < 0, na.rm = TRUE)
sum(!is.na(lagged$"`expenditure_1994-1999_budget_lag3`")) + sum(!is.na(lagged$"`expenditure_2000-2006_budget_lag3`")) + sum(!is.na(lagged$"`expenditure_2007-2013_budget_lag3`")) + sum(!is.na(lagged$"`expenditure_2014-2020_budget_lag3`"))
sum(lagged$"p.value_`expenditure_1994-1999_budget_lag3`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2000-2006_budget_lag3`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2007-2013_budget_lag3`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2014-2020_budget_lag3`" < 0.1, na.rm = TRUE)
```

#### 6.1.4

```{r}
# lag-5
regression_lagged <- map(list_lagged_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & 
                          endsWith(names(df), "_lag5")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_lagged, ~ summary(.x)$r.squared)
lagged <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

lagged <- lagged |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment") |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag5`", .after = "`expenditure_1994-1999_budget_lag5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag5`", .after = "`expenditure_2000-2006_budget_lag5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag5`", .after = "`expenditure_2007-2013_budget_lag5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag5`", .after = "`expenditure_2014-2020_budget_lag5`")

# Lag unemployment always significant
# expenditure rarely significant, often positive coefficient
print(paste("R-squared: ", mean(lagged$r_squared)))
sum(lagged$"`expenditure_1994-1999_budget_lag5`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2000-2006_budget_lag5`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2007-2013_budget_lag5`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2014-2020_budget_lag5`" < 0, na.rm = TRUE)
sum(!is.na(lagged$"`expenditure_1994-1999_budget_lag5`")) + sum(!is.na(lagged$"`expenditure_2000-2006_budget_lag5`")) + sum(!is.na(lagged$"`expenditure_2007-2013_budget_lag5`")) + sum(!is.na(lagged$"`expenditure_2014-2020_budget_lag5`"))
sum(lagged$"p.value_`expenditure_1994-1999_budget_lag5`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2000-2006_budget_lag5`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2007-2013_budget_lag5`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2014-2020_budget_lag5`" < 0.1, na.rm = TRUE)
```

### 6.2 Growth rates

#### 6.2.1

```{r}
# Un growth rate
regression_auto_gr <- map(list_auto_gr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))
  
  # poor_vars <- names(df)[startsWith(names(df), "poor")]
  # 
  # # Backtick only the expenditure vars
  # exp_vars_bt <- paste0("`", exp_vars, "`")
  # 
  # # Combine both
  # all_vars <- c(exp_vars_bt, poor_vars)
  # 
  # formula <- as.formula(paste(
  #   "unemployment ~ lag_unemployment +",
  #   paste(all_vars, collapse = " + ")
  # ))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_auto_gr, ~ summary(.x)$r.squared)
autoreg_gr <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_auto_gr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_auto_gr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

autoreg_gr <- autoreg_gr |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  # relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  # relocate("p.value_poor00_06", .after = "poor00_06") |>
  # relocate("p.value_poor07_13", .after = "poor07_13") |>
  # relocate("p.value_poor14_20", .after = "poor14_20") |>
  relocate("p.value_lag_unemployment", .after = "lag_unemployment")

# lag unemployment in gr not always significant
# expenditure often non significant, coefficients mainly negative, but also positive 
print(paste("R-squared: ", mean(autoreg_gr$r_squared)))
sum(autoreg_gr$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(autoreg_gr$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(autoreg_gr$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(autoreg_gr$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(autoreg_gr$"`expenditure_1994-1999_budget`")) + sum(!is.na(autoreg_gr$"`expenditure_2000-2006_budget`")) + sum(!is.na(autoreg_gr$"`expenditure_2007-2013_budget`")) + sum(!is.na(autoreg_gr$"`expenditure_2014-2020_budget`"))
sum(autoreg_gr$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(autoreg_gr$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(autoreg_gr$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(autoreg_gr$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

#### 6.2.2

```{r}
# lag-1
regression_lagged <- map(list_lagged_gr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & 
                          endsWith(names(df), "_lag1")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_lagged, ~ summary(.x)$r.squared)
lagged <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

lagged <- lagged |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment") |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag1`", .after = "`expenditure_1994-1999_budget_lag1`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag1`", .after = "`expenditure_2000-2006_budget_lag1`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag1`", .after = "`expenditure_2007-2013_budget_lag1`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag1`", .after = "`expenditure_2014-2020_budget_lag1`")

# mostly non-significant, coefficients both way
print(paste("R-squared: ", mean(lagged$r_squared)))
sum(lagged$"`expenditure_1994-1999_budget_lag1`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2000-2006_budget_lag1`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2007-2013_budget_lag1`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2014-2020_budget_lag1`" < 0, na.rm = TRUE)
sum(!is.na(lagged$"`expenditure_1994-1999_budget_lag1`")) + sum(!is.na(lagged$"`expenditure_2000-2006_budget_lag1`")) + sum(!is.na(lagged$"`expenditure_2007-2013_budget_lag1`")) + sum(!is.na(lagged$"`expenditure_2014-2020_budget_lag1`"))
sum(lagged$"p.value_`expenditure_1994-1999_budget_lag1`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2000-2006_budget_lag1`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2007-2013_budget_lag1`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2014-2020_budget_lag1`" < 0.1, na.rm = TRUE)
```

#### 6.2.3

```{r}
# lag-3
regression_lagged <- map(list_lagged_gr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & 
                          endsWith(names(df), "_lag3")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_lagged, ~ summary(.x)$r.squared)
lagged <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

lagged <- lagged |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment") |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag3`", .after = "`expenditure_1994-1999_budget_lag3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag3`", .after = "`expenditure_2000-2006_budget_lag3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag3`", .after = "`expenditure_2007-2013_budget_lag3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag3`", .after = "`expenditure_2014-2020_budget_lag3`")

# Seems more significance, coefficients still both ways
print(paste("R-squared: ", mean(lagged$r_squared)))
sum(lagged$"`expenditure_1994-1999_budget_lag3`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2000-2006_budget_lag3`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2007-2013_budget_lag3`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2014-2020_budget_lag3`" < 0, na.rm = TRUE)
sum(!is.na(lagged$"`expenditure_1994-1999_budget_lag3`")) + sum(!is.na(lagged$"`expenditure_2000-2006_budget_lag3`")) + sum(!is.na(lagged$"`expenditure_2007-2013_budget_lag3`")) + sum(!is.na(lagged$"`expenditure_2014-2020_budget_lag3`"))
sum(lagged$"p.value_`expenditure_1994-1999_budget_lag3`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2000-2006_budget_lag3`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2007-2013_budget_lag3`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2014-2020_budget_lag3`" < 0.1, na.rm = TRUE)
```

#### 6.2.4

```{r}
# lag-5
regression_lagged <- map(list_lagged_gr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & 
                          endsWith(names(df), "_lag5")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_lagged, ~ summary(.x)$r.squared)
lagged <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

lagged <- lagged |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment") |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag5`", .after = "`expenditure_1994-1999_budget_lag5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag5`", .after = "`expenditure_2000-2006_budget_lag5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag5`", .after = "`expenditure_2007-2013_budget_lag5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag5`", .after = "`expenditure_2014-2020_budget_lag5`")

# No significant changes
print(paste("R-squared: ", mean(lagged$r_squared)))
sum(lagged$"`expenditure_1994-1999_budget_lag5`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2000-2006_budget_lag5`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2007-2013_budget_lag5`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2014-2020_budget_lag5`" < 0, na.rm = TRUE)
sum(!is.na(lagged$"`expenditure_1994-1999_budget_lag5`")) + sum(!is.na(lagged$"`expenditure_2000-2006_budget_lag5`")) + sum(!is.na(lagged$"`expenditure_2007-2013_budget_lag5`")) + sum(!is.na(lagged$"`expenditure_2014-2020_budget_lag5`"))
sum(lagged$"p.value_`expenditure_1994-1999_budget_lag5`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2000-2006_budget_lag5`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2007-2013_budget_lag5`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2014-2020_budget_lag5`" < 0.1, na.rm = TRUE)
```

### 6.3 All growth rates

#### 6.3.1

```{r}
# Un growth rate
regression_auto_allgr <- map(list_auto_allgr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))
  
  # poor_vars <- names(df)[startsWith(names(df), "poor")]
  # 
  # # Backtick only the expenditure vars
  # exp_vars_bt <- paste0("`", exp_vars, "`")
  # 
  # # Combine both
  # all_vars <- c(exp_vars_bt, poor_vars)
  # 
  # formula <- as.formula(paste(
  #   "unemployment ~ lag_unemployment +",
  #   paste(all_vars, collapse = " + ")
  # ))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_auto_allgr, ~ summary(.x)$r.squared)
autoreg_allgr <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_auto_allgr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_auto_allgr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

autoreg_allgr <- autoreg_allgr |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  # relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  # relocate("p.value_poor00_06", .after = "poor00_06") |>
  # relocate("p.value_poor07_13", .after = "poor07_13") |>
  # relocate("p.value_poor14_20", .after = "poor14_20") |>
  relocate("p.value_lag_unemployment", .after = "lag_unemployment")

# lag unemployment in gr not always significant
# expenditure often non significant, coefficients mainly negative, but also positive 
print(paste("R-squared: ", mean(autoreg_allgr$r_squared)))
sum(autoreg_allgr$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(autoreg_allgr$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(autoreg_allgr$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(autoreg_allgr$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(autoreg_allgr$"`expenditure_1994-1999_budget`")) + sum(!is.na(autoreg_allgr$"`expenditure_2000-2006_budget`")) + sum(!is.na(autoreg_allgr$"`expenditure_2007-2013_budget`")) + sum(!is.na(autoreg_allgr$"`expenditure_2014-2020_budget`"))
sum(autoreg_allgr$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(autoreg_allgr$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(autoreg_allgr$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(autoreg_allgr$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

#### 6.3.2

```{r}
# lag-1
regression_lagged <- map(list_lagged_allgr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & 
                          endsWith(names(df), "_lag1")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_lagged, ~ summary(.x)$r.squared)
lagged <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

lagged <- lagged |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment") |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag1`", .after = "`expenditure_1994-1999_budget_lag1`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag1`", .after = "`expenditure_2000-2006_budget_lag1`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag1`", .after = "`expenditure_2007-2013_budget_lag1`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag1`", .after = "`expenditure_2014-2020_budget_lag1`")

# mostly non-significant, coefficients both way
print(paste("R-squared: ", mean(lagged$r_squared)))
sum(lagged$"`expenditure_1994-1999_budget_lag1`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2000-2006_budget_lag1`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2007-2013_budget_lag1`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2014-2020_budget_lag1`" < 0, na.rm = TRUE)
sum(!is.na(lagged$"`expenditure_1994-1999_budget_lag1`")) + sum(!is.na(lagged$"`expenditure_2000-2006_budget_lag1`")) + sum(!is.na(lagged$"`expenditure_2007-2013_budget_lag1`")) + sum(!is.na(lagged$"`expenditure_2014-2020_budget_lag1`"))
sum(lagged$"p.value_`expenditure_1994-1999_budget_lag1`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2000-2006_budget_lag1`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2007-2013_budget_lag1`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2014-2020_budget_lag1`" < 0.1, na.rm = TRUE)
```

#### 6.3.3

```{r}
# lag-3
regression_lagged <- map(list_lagged_allgr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & 
                          endsWith(names(df), "_lag3")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_lagged, ~ summary(.x)$r.squared)
lagged <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

lagged <- lagged |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment") |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag3`", .after = "`expenditure_1994-1999_budget_lag3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag3`", .after = "`expenditure_2000-2006_budget_lag3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag3`", .after = "`expenditure_2007-2013_budget_lag3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag3`", .after = "`expenditure_2014-2020_budget_lag3`")

# Seems more significance, coefficients still both ways
print(paste("R-squared: ", mean(lagged$r_squared)))
sum(lagged$"`expenditure_1994-1999_budget_lag3`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2000-2006_budget_lag3`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2007-2013_budget_lag3`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2014-2020_budget_lag3`" < 0, na.rm = TRUE)
sum(!is.na(lagged$"`expenditure_1994-1999_budget_lag3`")) + sum(!is.na(lagged$"`expenditure_2000-2006_budget_lag3`")) + sum(!is.na(lagged$"`expenditure_2007-2013_budget_lag3`")) + sum(!is.na(lagged$"`expenditure_2014-2020_budget_lag3`"))
sum(lagged$"p.value_`expenditure_1994-1999_budget_lag3`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2000-2006_budget_lag3`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2007-2013_budget_lag3`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2014-2020_budget_lag3`" < 0.1, na.rm = TRUE)
```

#### 6.3.4

```{r}
# lag-5
regression_lagged <- map(list_lagged_allgr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & 
                          endsWith(names(df), "_lag5")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ lag_unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression_lagged, ~ summary(.x)$r.squared)
lagged <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_lagged, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

lagged <- lagged |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("p.value_lag_unemployment", .after = "lag_unemployment") |> 
  relocate("p.value_`expenditure_1994-1999_budget_lag5`", .after = "`expenditure_1994-1999_budget_lag5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag5`", .after = "`expenditure_2000-2006_budget_lag5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag5`", .after = "`expenditure_2007-2013_budget_lag5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag5`", .after = "`expenditure_2014-2020_budget_lag5`")

# No significant changes
print(paste("R-squared: ", mean(lagged$r_squared)))
sum(lagged$"`expenditure_1994-1999_budget_lag5`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2000-2006_budget_lag5`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2007-2013_budget_lag5`" < 0, na.rm = TRUE) + sum(lagged$"`expenditure_2014-2020_budget_lag5`" < 0, na.rm = TRUE)
sum(!is.na(lagged$"`expenditure_1994-1999_budget_lag5`")) + sum(!is.na(lagged$"`expenditure_2000-2006_budget_lag5`")) + sum(!is.na(lagged$"`expenditure_2007-2013_budget_lag5`")) + sum(!is.na(lagged$"`expenditure_2014-2020_budget_lag5`"))
sum(lagged$"p.value_`expenditure_1994-1999_budget_lag5`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2000-2006_budget_lag5`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2007-2013_budget_lag5`" < 0.1, na.rm = TRUE) + sum(lagged$"p.value_`expenditure_2014-2020_budget_lag5`" < 0.1, na.rm = TRUE)
```

## 7) Growth rates over longer period of time

### 7.1 GDP + expediture

#### 7.1.1 Lagged expenditure

##### 7.1.1.1

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag2")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag2`", .after = "`expenditure_2000-2006_budget_lag2`") |>
  relocate("`expenditure_2014-2020_budget_lag2`", .after = "`expenditure_2007-2013_budget_lag2`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag2`", .after = "`expenditure_1994-1999_budget_lag2`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag2`", .after = "`expenditure_2000-2006_budget_lag2`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag2`", .after = "`expenditure_2007-2013_budget_lag2`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag2`", .after = "`expenditure_2014-2020_budget_lag2`") |> 
  relocate("p.value_gdp", .after = "gdp")

# better model, gdp almost always significant and negative, expenditure is sometimes significant, but coefficients still both ways
print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_lag2`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_lag2`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_lag2`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_lag2`" < 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_lag2`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_lag2`" < 0.1, na.rm = TRUE)
```

##### 7.1.1.2

```{r}
# 5 year period
regression <- map(list_gr5_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag4")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg5 <- regg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag4`", .after = "`expenditure_2000-2006_budget_lag4`") |>
  relocate("`expenditure_2014-2020_budget_lag4`", .after = "`expenditure_2007-2013_budget_lag4`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag4`", .after = "`expenditure_1994-1999_budget_lag4`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag4`", .after = "`expenditure_2000-2006_budget_lag4`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag4`", .after = "`expenditure_2007-2013_budget_lag4`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag4`", .after = "`expenditure_2014-2020_budget_lag4`") |> 
  relocate("p.value_gdp", .after = "gdp")

# gdp always significant and negative
# expenditure more significant, but coefficients still both ways
# improvement in r2
print(paste("R-squared: ", mean(regg5$r_squared)))
sum(regg5$"`expenditure_1994-1999_budget_lag4`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2000-2006_budget_lag4`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2007-2013_budget_lag4`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2014-2020_budget_lag4`" < 0, na.rm = TRUE)
sum(!is.na(regg5$"`expenditure_1994-1999_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2000-2006_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2007-2013_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2014-2020_budget_lag4`"))
sum(regg5$"p.value_`expenditure_1994-1999_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2000-2006_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2007-2013_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2014-2020_budget_lag4`" < 0.1, na.rm = TRUE)
```

##### 7.1.1.3

```{r}
# 5 year period
regression <- map(list_gr7_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag6")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg7 <- regg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag6`", .after = "`expenditure_2000-2006_budget_lag6`") |>
  relocate("`expenditure_2014-2020_budget_lag6`", .after = "`expenditure_2007-2013_budget_lag6`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag6`", .after = "`expenditure_1994-1999_budget_lag6`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag6`", .after = "`expenditure_2000-2006_budget_lag6`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag6`", .after = "`expenditure_2007-2013_budget_lag6`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag6`", .after = "`expenditure_2014-2020_budget_lag6`") |> 
  relocate("p.value_gdp", .after = "gdp")

# improves even more the r2, gdp almost always significant and always negative
# expenditure seems more significant, but coefficients still both ways
print(paste("R-squared: ", mean(regg7$r_squared)))
sum(regg7$"`expenditure_1994-1999_budget_lag6`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2000-2006_budget_lag6`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2007-2013_budget_lag6`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2014-2020_budget_lag6`" < 0, na.rm = TRUE)
sum(!is.na(regg7$"`expenditure_1994-1999_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2000-2006_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2007-2013_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2014-2020_budget_lag6`"))
sum(regg7$"p.value_`expenditure_1994-1999_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2000-2006_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2007-2013_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2014-2020_budget_lag6`" < 0.1, na.rm = TRUE)
```

#### 7.1.2 Summed expenditure

##### 7.1.2.1

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum3")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
modelsummary(
    models = regression,
    fmt = fmt_decimal(digits = 2),
    stars = TRUE,
    statistic = NULL,
    coef_map = c("gdp",
                 "expenditure_1994-1999_budget_rollsum3",
                 "expenditure_2000-2006_budget_rollsum3",
                 "expenditure_2007-2013_budget_rollsum3", 
                 "expenditure_2014-2020_budget_rollsum3"),
    gof_map = list(
        list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
        list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
        list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
    output = "okun.md"
)

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum3`", .after = "`expenditure_1994-1999_budget_rollsum3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2014-2020_budget_rollsum3`") |> 
  relocate("p.value_gdp", .after = "gdp")

# 
print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_rollsum3`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_rollsum3`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_rollsum3`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_rollsum3`" < 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_rollsum3`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_rollsum3`" < 0.1, na.rm = TRUE)
```

##### 7.1.2.2

```{r}
# 5 year period
regression <- map(list_gr5_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum5")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg5 <- regg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum5`", .after = "`expenditure_2000-2006_budget_rollsum5`") |>
  relocate("`expenditure_2014-2020_budget_rollsum5`", .after = "`expenditure_2007-2013_budget_rollsum5`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum5`", .after = "`expenditure_1994-1999_budget_rollsum5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum5`", .after = "`expenditure_2000-2006_budget_rollsum5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum5`", .after = "`expenditure_2007-2013_budget_rollsum5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum5`", .after = "`expenditure_2014-2020_budget_rollsum5`") |> 
  relocate("p.value_gdp", .after = "gdp")

# 
print(paste("R-squared: ", mean(regg5$r_squared)))
sum(regg5$"`expenditure_1994-1999_budget_rollsum5`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2000-2006_budget_rollsum5`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2007-2013_budget_rollsum5`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2014-2020_budget_rollsum5`" < 0, na.rm = TRUE)
sum(!is.na(regg5$"`expenditure_1994-1999_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2000-2006_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2007-2013_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2014-2020_budget_rollsum5`"))
sum(regg5$"p.value_`expenditure_1994-1999_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2000-2006_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2007-2013_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2014-2020_budget_rollsum5`" < 0.1, na.rm = TRUE)
```

##### 7.1.2.3

```{r}
# 5 year period
regression <- map(list_gr7_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum7")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg7 <- regg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum7`", .after = "`expenditure_2000-2006_budget_rollsum7`") |>
  relocate("`expenditure_2014-2020_budget_rollsum7`", .after = "`expenditure_2007-2013_budget_rollsum7`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum7`", .after = "`expenditure_1994-1999_budget_rollsum7`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum7`", .after = "`expenditure_2000-2006_budget_rollsum7`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum7`", .after = "`expenditure_2007-2013_budget_rollsum7`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum7`", .after = "`expenditure_2014-2020_budget_rollsum7`") |> 
  relocate("p.value_gdp", .after = "gdp")

# 
print(paste("R-squared: ", mean(regg7$r_squared)))
sum(regg7$"`expenditure_1994-1999_budget_rollsum7`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2000-2006_budget_rollsum7`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2007-2013_budget_rollsum7`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2014-2020_budget_rollsum7`" < 0, na.rm = TRUE)
sum(!is.na(regg7$"`expenditure_1994-1999_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2000-2006_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2007-2013_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2014-2020_budget_rollsum7`"))
sum(regg7$"p.value_`expenditure_1994-1999_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2000-2006_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2007-2013_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2014-2020_budget_rollsum7`" < 0.1, na.rm = TRUE)
```

### 7.2 Adding poor binaries

#### 7.2.1 Lagged expenditure

##### 7.2.1.1

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag2")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag2`", .after = "`expenditure_2000-2006_budget_lag2`") |>
  relocate("`expenditure_2014-2020_budget_lag2`", .after = "`expenditure_2007-2013_budget_lag2`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag2`", .after = "`expenditure_1994-1999_budget_lag2`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag2`", .after = "`expenditure_2000-2006_budget_lag2`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag2`", .after = "`expenditure_2007-2013_budget_lag2`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag2`", .after = "`expenditure_2014-2020_budget_lag2`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# poor binaries do not change much, bit higher rsquared worse performance for expenditure
print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_lag2`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_lag2`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_lag2`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_lag2`" < 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_lag2`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_lag2`" < 0.1, na.rm = TRUE)
```

##### 7.2.1.2

```{r}
# 5 year period
regression <- map(list_gr5_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag4")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg5 <- regg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag4`", .after = "`expenditure_2000-2006_budget_lag4`") |>
  relocate("`expenditure_2014-2020_budget_lag4`", .after = "`expenditure_2007-2013_budget_lag4`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag4`", .after = "`expenditure_1994-1999_budget_lag4`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag4`", .after = "`expenditure_2000-2006_budget_lag4`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag4`", .after = "`expenditure_2007-2013_budget_lag4`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag4`", .after = "`expenditure_2014-2020_budget_lag4`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

#
print(paste("R-squared: ", mean(regg5$r_squared)))
sum(regg5$"`expenditure_1994-1999_budget_lag4`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2000-2006_budget_lag4`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2007-2013_budget_lag4`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2014-2020_budget_lag4`" < 0, na.rm = TRUE)
sum(!is.na(regg5$"`expenditure_1994-1999_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2000-2006_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2007-2013_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2014-2020_budget_lag4`"))
sum(regg5$"p.value_`expenditure_1994-1999_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2000-2006_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2007-2013_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2014-2020_budget_lag4`" < 0.1, na.rm = TRUE)
```

##### 7.2.1.3

```{r}
# 7 year period
regression <- map(list_gr7_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag6")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg7 <- regg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag6`", .after = "`expenditure_2000-2006_budget_lag6`") |>
  relocate("`expenditure_2014-2020_budget_lag6`", .after = "`expenditure_2007-2013_budget_lag6`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag6`", .after = "`expenditure_1994-1999_budget_lag6`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag6`", .after = "`expenditure_2000-2006_budget_lag6`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag6`", .after = "`expenditure_2007-2013_budget_lag6`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag6`", .after = "`expenditure_2014-2020_budget_lag6`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

print(paste("R-squared: ", mean(regg7$r_squared)))
sum(regg7$"`expenditure_1994-1999_budget_lag6`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2000-2006_budget_lag6`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2007-2013_budget_lag6`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2014-2020_budget_lag6`" < 0, na.rm = TRUE)
sum(!is.na(regg7$"`expenditure_1994-1999_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2000-2006_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2007-2013_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2014-2020_budget_lag6`"))
sum(regg7$"p.value_`expenditure_1994-1999_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2000-2006_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2007-2013_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2014-2020_budget_lag6`" < 0.1, na.rm = TRUE)
# poor binaries do not change much they are usually not significant and with both positive and negative coefficients
```


#### 7.2.2 Summed expenditure

##### 7.2.2.1

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum3")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum3`", .after = "`expenditure_1994-1999_budget_rollsum3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2014-2020_budget_rollsum3`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# 
print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_rollsum3`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_rollsum3`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_rollsum3`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_rollsum3`" < 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_rollsum3`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_rollsum3`" < 0.1, na.rm = TRUE)
```

##### 7.2.2.2

```{r}
# 5 year period
regression <- map(list_gr5_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum5")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg5 <- regg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum5`", .after = "`expenditure_2000-2006_budget_rollsum5`") |>
  relocate("`expenditure_2014-2020_budget_rollsum5`", .after = "`expenditure_2007-2013_budget_rollsum5`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum5`", .after = "`expenditure_1994-1999_budget_rollsum5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum5`", .after = "`expenditure_2000-2006_budget_rollsum5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum5`", .after = "`expenditure_2007-2013_budget_rollsum5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum5`", .after = "`expenditure_2014-2020_budget_rollsum5`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

#
print(paste("R-squared: ", mean(regg5$r_squared)))
sum(regg5$"`expenditure_1994-1999_budget_rollsum5`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2000-2006_budget_rollsum5`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2007-2013_budget_rollsum5`" < 0, na.rm = TRUE) + sum(regg5$"`expenditure_2014-2020_budget_rollsum5`" < 0, na.rm = TRUE)
sum(!is.na(regg5$"`expenditure_1994-1999_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2000-2006_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2007-2013_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2014-2020_budget_rollsum5`"))
sum(regg5$"p.value_`expenditure_1994-1999_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2000-2006_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2007-2013_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2014-2020_budget_rollsum5`" < 0.1, na.rm = TRUE)
```

##### 7.2.2.3

```{r}
# 7 year period
regression <- map(list_gr7_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum7")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg7 <- regg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum7`", .after = "`expenditure_2000-2006_budget_rollsum7`") |>
  relocate("`expenditure_2014-2020_budget_rollsum7`", .after = "`expenditure_2007-2013_budget_rollsum7`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum7`", .after = "`expenditure_1994-1999_budget_rollsum7`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum7`", .after = "`expenditure_2000-2006_budget_rollsum7`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum7`", .after = "`expenditure_2007-2013_budget_rollsum7`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum7`", .after = "`expenditure_2014-2020_budget_rollsum7`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

print(paste("R-squared: ", mean(regg7$r_squared)))
sum(regg7$"`expenditure_1994-1999_budget_rollsum7`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2000-2006_budget_rollsum7`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2007-2013_budget_rollsum7`" < 0, na.rm = TRUE) + sum(regg7$"`expenditure_2014-2020_budget_rollsum7`" < 0, na.rm = TRUE)
sum(!is.na(regg7$"`expenditure_1994-1999_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2000-2006_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2007-2013_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2014-2020_budget_rollsum7`"))
sum(regg7$"p.value_`expenditure_1994-1999_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2000-2006_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2007-2013_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2014-2020_budget_rollsum7`" < 0.1, na.rm = TRUE)
```

## 8) Averages over long period of time

### 8.1 Absolute values

#### 8.1.1 GDP + expediture

##### 8.1.1.1

```{r}
# 3-years period
regression <- map(list_avg3_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg3")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg3 <- avg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg3`", .after = "`expenditure_1994-1999_budget_avg3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2014-2020_budget_avg3`") |> 
  relocate("p.value_gdp", .after = "gdp")

# gdp almost always significant and negative
# expenditure often significant but positive
print(paste("R-squared: ", mean(avg3$r_squared)))
sum(avg3$"`expenditure_1994-1999_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2000-2006_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2007-2013_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2014-2020_budget_avg3`" < 0, na.rm = TRUE)
sum(!is.na(avg3$"`expenditure_1994-1999_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2000-2006_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2007-2013_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2014-2020_budget_avg3`"))
sum(avg3$"p.value_`expenditure_1994-1999_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2000-2006_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2007-2013_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2014-2020_budget_avg3`" < 0.1, na.rm = TRUE)
```

##### 8.1.1.2

```{r}
# 5-years period
regression <- map(list_avg5_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg5")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg5 <- avg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg5`", .after = "`expenditure_2000-2006_budget_avg5`") |>
  relocate("`expenditure_2014-2020_budget_avg5`", .after = "`expenditure_2007-2013_budget_avg5`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg5`", .after = "`expenditure_1994-1999_budget_avg5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg5`", .after = "`expenditure_2000-2006_budget_avg5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg5`", .after = "`expenditure_2007-2013_budget_avg5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg5`", .after = "`expenditure_2014-2020_budget_avg5`") |> 
  relocate("p.value_gdp", .after = "gdp")

# gdp always significant and negative
# improvement in rsquared
# expenditure often significant but primarly positive
print(paste("R-squared: ", mean(avg5$r_squared)))
sum(avg5$"`expenditure_1994-1999_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2000-2006_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2007-2013_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2014-2020_budget_avg5`" < 0, na.rm = TRUE)
sum(!is.na(avg5$"`expenditure_1994-1999_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2000-2006_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2007-2013_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2014-2020_budget_avg5`"))
sum(avg5$"p.value_`expenditure_1994-1999_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2000-2006_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2007-2013_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2014-2020_budget_avg5`" < 0.1, na.rm = TRUE)
```

##### 8.1.1.3

```{r}
# 7-years period
regression <- map(list_avg7_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg7")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg7 <- avg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg7`", .after = "`expenditure_2000-2006_budget_avg7`") |>
  relocate("`expenditure_2014-2020_budget_avg7`", .after = "`expenditure_2007-2013_budget_avg7`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg7`", .after = "`expenditure_1994-1999_budget_avg7`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg7`", .after = "`expenditure_2000-2006_budget_avg7`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg7`", .after = "`expenditure_2007-2013_budget_avg7`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg7`", .after = "`expenditure_2014-2020_budget_avg7`") |> 
  relocate("p.value_gdp", .after = "gdp")

# gdp always significant and negative
# expenditure primarly positive
print(paste("R-squared: ", mean(avg7$r_squared)))
sum(avg7$"`expenditure_1994-1999_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2000-2006_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2007-2013_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2014-2020_budget_avg7`" < 0, na.rm = TRUE)
sum(!is.na(avg7$"`expenditure_1994-1999_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2000-2006_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2007-2013_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2014-2020_budget_avg7`"))
sum(avg7$"p.value_`expenditure_1994-1999_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2000-2006_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2007-2013_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2014-2020_budget_avg7`" < 0.1, na.rm = TRUE)
```

#### 8.1.2 Adding poor binaries

##### 8.1.2.1

```{r}
# 3-years period
regression <- map(list_avg3_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg3")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})
modelsummary(
    models = regression,
    fmt = fmt_decimal(digits = 2),
    stars = TRUE,
    statistic = NULL,
    coef_map = c("gdp",
                 "expenditure_1994-1999_budget_avg3",
                 "expenditure_2000-2006_budget_avg3",
                 "expenditure_2007-2013_budget_avg3", 
                 "expenditure_2014-2020_budget_avg3",
                 "poor00_06", "poor07_13", "poor14_20"),
    gof_map = list(
        list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
        list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
        list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
    output = "avg.md"
)

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg3 <- avg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg3`", .after = "`expenditure_1994-1999_budget_avg3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2014-2020_budget_avg3`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# gdp less significant (stilll mostly significant), always negative 
# expenditure very often significant primarly positive
# poor dummies almost always significant, initally positive then negative
print(paste("R-squared: ", mean(avg3$r_squared)))
sum(avg3$"`expenditure_1994-1999_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2000-2006_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2007-2013_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2014-2020_budget_avg3`" < 0, na.rm = TRUE)
sum(!is.na(avg3$"`expenditure_1994-1999_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2000-2006_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2007-2013_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2014-2020_budget_avg3`"))
sum(avg3$"p.value_`expenditure_1994-1999_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2000-2006_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2007-2013_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2014-2020_budget_avg3`" < 0.1, na.rm = TRUE)
```

##### 8.1.2.2

```{r}
# 5-years period
regression <- map(list_avg5_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg5")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg5 <- avg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg5`", .after = "`expenditure_2000-2006_budget_avg5`") |>
  relocate("`expenditure_2014-2020_budget_avg5`", .after = "`expenditure_2007-2013_budget_avg5`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg5`", .after = "`expenditure_1994-1999_budget_avg5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg5`", .after = "`expenditure_2000-2006_budget_avg5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg5`", .after = "`expenditure_2007-2013_budget_avg5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg5`", .after = "`expenditure_2014-2020_budget_avg5`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# gdp always negative, mostly significant (not significant in early 2000s)
# expenditure often significant but primarly positive
# poor dummies almost always significant, initally positive then negative
print(paste("R-squared: ", mean(avg5$r_squared)))
sum(avg5$"`expenditure_1994-1999_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2000-2006_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2007-2013_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2014-2020_budget_avg5`" < 0, na.rm = TRUE)
sum(!is.na(avg5$"`expenditure_1994-1999_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2000-2006_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2007-2013_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2014-2020_budget_avg5`"))
sum(avg5$"p.value_`expenditure_1994-1999_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2000-2006_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2007-2013_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2014-2020_budget_avg5`" < 0.1, na.rm = TRUE)
```

##### 8.1.2.3

```{r}
# 7-years period
regression <- map(list_avg7_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg7")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg7 <- avg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg7`", .after = "`expenditure_2000-2006_budget_avg7`") |>
  relocate("`expenditure_2014-2020_budget_avg7`", .after = "`expenditure_2007-2013_budget_avg7`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg7`", .after = "`expenditure_1994-1999_budget_avg7`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg7`", .after = "`expenditure_2000-2006_budget_avg7`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg7`", .after = "`expenditure_2007-2013_budget_avg7`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg7`", .after = "`expenditure_2014-2020_budget_avg7`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# gdp always significant and negative
# expenditure often significant but almost always positive
# poor dummies almost always significant, initally positive then negative
print(paste("R-squared: ", mean(avg7$r_squared)))
sum(avg7$"`expenditure_1994-1999_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2000-2006_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2007-2013_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2014-2020_budget_avg7`" < 0, na.rm = TRUE)
sum(!is.na(avg7$"`expenditure_1994-1999_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2000-2006_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2007-2013_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2014-2020_budget_avg7`"))
sum(avg7$"p.value_`expenditure_1994-1999_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2000-2006_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2007-2013_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2014-2020_budget_avg7`" < 0.1, na.rm = TRUE)
```

### 8.2 Growth rates

#### 8.2.1 GDP + expediture

##### 8.2.1.1

```{r}
# 3-years period
regression <- map(list_avg3gr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg3")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg3 <- avg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg3`", .after = "`expenditure_1994-1999_budget_avg3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2014-2020_budget_avg3`") |> 
  relocate("p.value_gdp", .after = "gdp")


print(paste("R-squared: ", mean(avg3$r_squared)))
sum(avg3$"`expenditure_1994-1999_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2000-2006_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2007-2013_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2014-2020_budget_avg3`" < 0, na.rm = TRUE)
sum(!is.na(avg3$"`expenditure_1994-1999_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2000-2006_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2007-2013_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2014-2020_budget_avg3`"))
sum(avg3$"p.value_`expenditure_1994-1999_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2000-2006_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2007-2013_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2014-2020_budget_avg3`" < 0.1, na.rm = TRUE)
```

##### 8.2.1.2

```{r}
# 5-years period
regression <- map(list_avg5gr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg5")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg5 <- avg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg5`", .after = "`expenditure_2000-2006_budget_avg5`") |>
  relocate("`expenditure_2014-2020_budget_avg5`", .after = "`expenditure_2007-2013_budget_avg5`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg5`", .after = "`expenditure_1994-1999_budget_avg5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg5`", .after = "`expenditure_2000-2006_budget_avg5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg5`", .after = "`expenditure_2007-2013_budget_avg5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg5`", .after = "`expenditure_2014-2020_budget_avg5`") |> 
  relocate("p.value_gdp", .after = "gdp")


print(paste("R-squared: ", mean(avg5$r_squared)))
sum(avg5$"`expenditure_1994-1999_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2000-2006_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2007-2013_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2014-2020_budget_avg5`" < 0, na.rm = TRUE)
sum(!is.na(avg5$"`expenditure_1994-1999_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2000-2006_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2007-2013_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2014-2020_budget_avg5`"))
sum(avg5$"p.value_`expenditure_1994-1999_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2000-2006_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2007-2013_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2014-2020_budget_avg5`" < 0.1, na.rm = TRUE)
```

##### 8.2.1.3

```{r}
# 7-years period
regression <- map(list_avg7gr_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg7")]

  # Build the regression formula
  formula <- as.formula(paste("unemployment ~ gdp +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg7 <- avg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg7`", .after = "`expenditure_2000-2006_budget_avg7`") |>
  relocate("`expenditure_2014-2020_budget_avg7`", .after = "`expenditure_2007-2013_budget_avg7`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg7`", .after = "`expenditure_1994-1999_budget_avg7`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg7`", .after = "`expenditure_2000-2006_budget_avg7`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg7`", .after = "`expenditure_2007-2013_budget_avg7`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg7`", .after = "`expenditure_2014-2020_budget_avg7`") |> 
  relocate("p.value_gdp", .after = "gdp")


print(paste("R-squared: ", mean(avg7$r_squared)))
sum(avg7$"`expenditure_1994-1999_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2000-2006_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2007-2013_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2014-2020_budget_avg7`" < 0, na.rm = TRUE)
sum(!is.na(avg7$"`expenditure_1994-1999_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2000-2006_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2007-2013_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2014-2020_budget_avg7`"))
sum(avg7$"p.value_`expenditure_1994-1999_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2000-2006_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2007-2013_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2014-2020_budget_avg7`" < 0.1, na.rm = TRUE)
```

#### 8.2.2 Adding poor binaries

##### 8.2.2.1

```{r}
# 3-years period
regression <- map(list_avg3gr_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg3")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg3 <- avg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg3`", .after = "`expenditure_1994-1999_budget_avg3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2014-2020_budget_avg3`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# gdp less significant (stilll mostly significant), always negative 
# expenditure very often significant primarly positive
# poor dummies almost always significant, initally positive then negative
print(paste("R-squared: ", mean(avg3$r_squared)))
sum(avg3$"`expenditure_1994-1999_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2000-2006_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2007-2013_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2014-2020_budget_avg3`" < 0, na.rm = TRUE)
sum(!is.na(avg3$"`expenditure_1994-1999_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2000-2006_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2007-2013_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2014-2020_budget_avg3`"))
sum(avg3$"p.value_`expenditure_1994-1999_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2000-2006_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2007-2013_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2014-2020_budget_avg3`" < 0.1, na.rm = TRUE)
```

##### 8.2.2.2

```{r}
# 5-years period
regression <- map(list_avg5gr_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg5")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg5 <- avg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg5`", .after = "`expenditure_2000-2006_budget_avg5`") |>
  relocate("`expenditure_2014-2020_budget_avg5`", .after = "`expenditure_2007-2013_budget_avg5`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg5`", .after = "`expenditure_1994-1999_budget_avg5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg5`", .after = "`expenditure_2000-2006_budget_avg5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg5`", .after = "`expenditure_2007-2013_budget_avg5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg5`", .after = "`expenditure_2014-2020_budget_avg5`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# gdp always negative, mostly significant (not significant in early 2000s)
# expenditure often significant but primarly positive
# poor dummies almost always significant, initally positive then negative
print(paste("R-squared: ", mean(avg5$r_squared)))
sum(avg5$"`expenditure_1994-1999_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2000-2006_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2007-2013_budget_avg5`" < 0, na.rm = TRUE) + sum(avg5$"`expenditure_2014-2020_budget_avg5`" < 0, na.rm = TRUE)
sum(!is.na(avg5$"`expenditure_1994-1999_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2000-2006_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2007-2013_budget_avg5`")) + sum(!is.na(avg5$"`expenditure_2014-2020_budget_avg5`"))
sum(avg5$"p.value_`expenditure_1994-1999_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2000-2006_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2007-2013_budget_avg5`" < 0.1, na.rm = TRUE) + sum(avg5$"p.value_`expenditure_2014-2020_budget_avg5`" < 0.1, na.rm = TRUE)
```

##### 8.2.2.3

```{r}
# 7-years period
regression <- map(list_avg7gr_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg7")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg7 <- avg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg7`", .after = "`expenditure_2000-2006_budget_avg7`") |>
  relocate("`expenditure_2014-2020_budget_avg7`", .after = "`expenditure_2007-2013_budget_avg7`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg7`", .after = "`expenditure_1994-1999_budget_avg7`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg7`", .after = "`expenditure_2000-2006_budget_avg7`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg7`", .after = "`expenditure_2007-2013_budget_avg7`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg7`", .after = "`expenditure_2014-2020_budget_avg7`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# gdp always significant and negative
# expenditure often significant but almost always positive
# poor dummies almost always significant, initally positive then negative
print(paste("R-squared: ", mean(avg7$r_squared)))
sum(avg7$"`expenditure_1994-1999_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2000-2006_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2007-2013_budget_avg7`" < 0, na.rm = TRUE) + sum(avg7$"`expenditure_2014-2020_budget_avg7`" < 0, na.rm = TRUE)
sum(!is.na(avg7$"`expenditure_1994-1999_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2000-2006_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2007-2013_budget_avg7`")) + sum(!is.na(avg7$"`expenditure_2014-2020_budget_avg7`"))
sum(avg7$"p.value_`expenditure_1994-1999_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2000-2006_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2007-2013_budget_avg7`" < 0.1, na.rm = TRUE) + sum(avg7$"p.value_`expenditure_2014-2020_budget_avg7`" < 0.1, na.rm = TRUE)
```

## 10) GDP

### 10.1 Absolute terms

```{r}
ab_gdp <- map(list_data_cleaned, ~ .x |>
                select(starts_with("expenditure"), unemployment, investment,
                       starts_with("poor"), gdp))

regression <- map(ab_gdp, ~ lm(gdp ~ ., data = .x))

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
res <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

res <- res |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_unemployment", .after = "unemployment") |>
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")


mean(res$r_squared)
sum(res$"`expenditure_1994-1999_budget`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2000-2006_budget`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2007-2013_budget`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2014-2020_budget`" > 0, na.rm = TRUE)
sum(!is.na(res$"`expenditure_1994-1999_budget`")) + sum(!is.na(res$"`expenditure_2000-2006_budget`")) + sum(!is.na(res$"`expenditure_2007-2013_budget`")) + sum(!is.na(res$"`expenditure_2014-2020_budget`"))
sum(res$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

### 10.2 Growth rate gdp and unemployment

#### 10.2.1

```{r}
# current expenditure
gr_gdp <- map(list_gr_gdp, ~ .x |>
                select(starts_with("expenditure"),
                       # starts_with("poor"),
                       # investment,
                       unemployment,
                       gdp))

regression <- map(gr_gdp, ~ lm(gdp ~ ., data = .x))

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
res <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

res <- res |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_unemployment", .after = "unemployment") |>
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") # |> 
  # relocate("p.value_poor00_06", .after = "poor00_06") |>
  # relocate("p.value_poor07_13", .after = "poor07_13") |>
  # relocate("p.value_poor14_20", .after = "poor14_20")


mean(res$r_squared)
sum(res$"`expenditure_1994-1999_budget`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2000-2006_budget`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2007-2013_budget`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2014-2020_budget`" > 0, na.rm = TRUE)
sum(!is.na(res$"`expenditure_1994-1999_budget`")) + sum(!is.na(res$"`expenditure_2000-2006_budget`")) + sum(!is.na(res$"`expenditure_2007-2013_budget`")) + sum(!is.na(res$"`expenditure_2014-2020_budget`"))
sum(res$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

#### 10.2.2

```{r}
# lag-1 expenditure
lag1_gr_gdp <- map(list_lag1_gr_gdp, ~ .x |>
                select((starts_with("expenditure") & ends_with("lag1")), 
                       unemployment, gdp))

regression <- map(lag1_gr_gdp, ~ lm(gdp ~ ., data = .x))

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
res <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

res <- res |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("unemployment", .after = everything()) |> 
  relocate("`expenditure_2007-2013_budget_lag1`", .after = "`expenditure_2000-2006_budget_lag1`") |>
  relocate("`expenditure_2014-2020_budget_lag1`", .after = "`expenditure_2007-2013_budget_lag1`") |>
  relocate("p.value_unemployment", .after = "unemployment") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag1`", .after = "`expenditure_1994-1999_budget_lag1`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag1`", .after = "`expenditure_2000-2006_budget_lag1`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag1`", .after = "`expenditure_2007-2013_budget_lag1`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag1`", .after = "`expenditure_2014-2020_budget_lag1`") 

mean(res$r_squared)
sum(res$"`expenditure_1994-1999_budget_lag1`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2000-2006_budget_lag1`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2007-2013_budget_lag1`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2014-2020_budget_lag1`" > 0, na.rm = TRUE)
sum(!is.na(res$"`expenditure_1994-1999_budget_lag1`")) + sum(!is.na(res$"`expenditure_2000-2006_budget_lag1`")) + sum(!is.na(res$"`expenditure_2007-2013_budget_lag1`")) + sum(!is.na(res$"`expenditure_2014-2020_budget_lag1`"))
sum(res$"p.value_`expenditure_1994-1999_budget_lag1`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2000-2006_budget_lag1`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2007-2013_budget_lag1`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2014-2020_budget_lag1`" < 0.1, na.rm = TRUE)
```

#### 10.2.3

```{r}
# lag-3 expenditure
lag3_gr_gdp <- map(list_lag3_gr_gdp, ~ .x |>
                select((starts_with("expenditure") & ends_with("lag3")), 
                       unemployment, gdp))

regression <- map(lag3_gr_gdp, ~ lm(gdp ~ ., data = .x))

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
res <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

res <- res |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("unemployment", .after = everything()) |> 
  relocate("`expenditure_2007-2013_budget_lag3`", .after = "`expenditure_2000-2006_budget_lag3`") |>
  relocate("`expenditure_2014-2020_budget_lag3`", .after = "`expenditure_2007-2013_budget_lag3`") |>
  relocate("p.value_unemployment", .after = "unemployment") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag3`", .after = "`expenditure_1994-1999_budget_lag3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag3`", .after = "`expenditure_2000-2006_budget_lag3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag3`", .after = "`expenditure_2007-2013_budget_lag3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag3`", .after = "`expenditure_2014-2020_budget_lag3`") 


mean(res$r_squared)
sum(res$"`expenditure_1994-1999_budget_lag3`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2000-2006_budget_lag3`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2007-2013_budget_lag3`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2014-2020_budget_lag3`" > 0, na.rm = TRUE)
sum(!is.na(res$"`expenditure_1994-1999_budget_lag3`")) + sum(!is.na(res$"`expenditure_2000-2006_budget_lag3`")) + sum(!is.na(res$"`expenditure_2007-2013_budget_lag3`")) + sum(!is.na(res$"`expenditure_2014-2020_budget_lag3`"))
sum(res$"p.value_`expenditure_1994-1999_budget_lag3`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2000-2006_budget_lag3`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2007-2013_budget_lag3`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2014-2020_budget_lag3`" < 0.1, na.rm = TRUE)
```

#### 10.2.4

```{r}
# lag 5 expenditure
lag5_gr_gdp <- map(list_lag5_gr_gdp, ~ .x |>
                select((starts_with("expenditure") & ends_with("lag5")), 
                       unemployment, gdp))

regression <- map(lag5_gr_gdp, ~ lm(gdp ~ ., data = .x))

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
res <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

res <- res |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("unemployment", .after = everything()) |> 
  relocate("`expenditure_2007-2013_budget_lag5`", .after = "`expenditure_2000-2006_budget_lag5`") |>
  relocate("`expenditure_2014-2020_budget_lag5`", .after = "`expenditure_2007-2013_budget_lag5`") |>
  relocate("p.value_unemployment", .after = "unemployment") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag5`", .after = "`expenditure_1994-1999_budget_lag5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag5`", .after = "`expenditure_2000-2006_budget_lag5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag5`", .after = "`expenditure_2007-2013_budget_lag5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag5`", .after = "`expenditure_2014-2020_budget_lag5`") 

mean(res$r_squared)
sum(res$"`expenditure_1994-1999_budget_lag5`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2000-2006_budget_lag5`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2007-2013_budget_lag5`" > 0, na.rm = TRUE) + sum(res$"`expenditure_2014-2020_budget_lag5`" > 0, na.rm = TRUE)
sum(!is.na(res$"`expenditure_1994-1999_budget_lag5`")) + sum(!is.na(res$"`expenditure_2000-2006_budget_lag5`")) + sum(!is.na(res$"`expenditure_2007-2013_budget_lag5`")) + sum(!is.na(res$"`expenditure_2014-2020_budget_lag5`"))
sum(res$"p.value_`expenditure_1994-1999_budget_lag5`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2000-2006_budget_lag5`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2007-2013_budget_lag5`" < 0.1, na.rm = TRUE) + sum(res$"p.value_`expenditure_2014-2020_budget_lag5`" < 0.1, na.rm = TRUE)

# Lagging does not increase R2 nor significance
```

### 10.3 Okun with GDP as dependent

#### 10.3.1 Lagged expenditure only

##### 10.3.1.1

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag2")]

  # Build the regression formula
  formula <- as.formula(paste("gdp ~ unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag2`", .after = "`expenditure_2000-2006_budget_lag2`") |>
  relocate("`expenditure_2014-2020_budget_lag2`", .after = "`expenditure_2007-2013_budget_lag2`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag2`", .after = "`expenditure_1994-1999_budget_lag2`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag2`", .after = "`expenditure_2000-2006_budget_lag2`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag2`", .after = "`expenditure_2007-2013_budget_lag2`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag2`", .after = "`expenditure_2014-2020_budget_lag2`") |> 
  relocate("p.value_unemployment", .after = "unemployment")


print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_lag2`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_lag2`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_lag2`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_lag2`" > 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_lag2`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_lag2`" < 0.1, na.rm = TRUE)
```

##### 10.3.1.2

```{r}
# 5 year period
regression <- map(list_gr5_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag4")]

  # Build the regression formula
  formula <- as.formula(paste("gdp ~ unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg5 <- regg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag4`", .after = "`expenditure_2000-2006_budget_lag4`") |>
  relocate("`expenditure_2014-2020_budget_lag4`", .after = "`expenditure_2007-2013_budget_lag4`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag4`", .after = "`expenditure_1994-1999_budget_lag4`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag4`", .after = "`expenditure_2000-2006_budget_lag4`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag4`", .after = "`expenditure_2007-2013_budget_lag4`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag4`", .after = "`expenditure_2014-2020_budget_lag4`") |> 
  relocate("p.value_unemployment", .after = "unemployment")


print(paste("R-squared: ", mean(regg5$r_squared)))
sum(regg5$"`expenditure_1994-1999_budget_lag4`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2000-2006_budget_lag4`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2007-2013_budget_lag4`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2014-2020_budget_lag4`" > 0, na.rm = TRUE)
sum(!is.na(regg5$"`expenditure_1994-1999_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2000-2006_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2007-2013_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2014-2020_budget_lag4`"))
sum(regg5$"p.value_`expenditure_1994-1999_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2000-2006_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2007-2013_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2014-2020_budget_lag4`" < 0.1, na.rm = TRUE)
```

##### 10.3.1.3

```{r}
# 7 year period
regression <- map(list_gr7_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag6")]

  # Build the regression formula
  formula <- as.formula(paste("gdp ~ unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg7 <- regg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag6`", .after = "`expenditure_2000-2006_budget_lag6`") |>
  relocate("`expenditure_2014-2020_budget_lag6`", .after = "`expenditure_2007-2013_budget_lag6`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag6`", .after = "`expenditure_1994-1999_budget_lag6`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag6`", .after = "`expenditure_2000-2006_budget_lag6`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag6`", .after = "`expenditure_2007-2013_budget_lag6`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag6`", .after = "`expenditure_2014-2020_budget_lag6`") |> 
  relocate("p.value_unemployment", .after = "unemployment")

# improves even more the r2, gdp almost always significant and always negative
# expenditure seems more significant, but coefficients still both ways
print(paste("R-squared: ", mean(regg7$r_squared)))
sum(regg7$"`expenditure_1994-1999_budget_lag6`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2000-2006_budget_lag6`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2007-2013_budget_lag6`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2014-2020_budget_lag6`" > 0, na.rm = TRUE)
sum(!is.na(regg7$"`expenditure_1994-1999_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2000-2006_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2007-2013_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2014-2020_budget_lag6`"))
sum(regg7$"p.value_`expenditure_1994-1999_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2000-2006_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2007-2013_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2014-2020_budget_lag6`" < 0.1, na.rm = TRUE)
```

#### 10.3.2 Summed expenditure only 

##### 10.3.2.1

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum3")]

  # Build the regression formula
  formula <- as.formula(paste("gdp ~ unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})
modelsummary(
    models = regression,
    fmt = fmt_decimal(digits = 2),
    stars = TRUE,
    statistic = NULL,
    coef_map = c("unemployment",
                 "expenditure_1994-1999_budget_rollsum3",
                 "expenditure_2000-2006_budget_rollsum3",
                 "expenditure_2007-2013_budget_rollsum3", 
                 "expenditure_2014-2020_budget_rollsum3"),
    gof_map = list(
        list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
        list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
        list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
    output = "gdp_nop.md"
)

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum3`", .after = "`expenditure_1994-1999_budget_rollsum3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2014-2020_budget_rollsum3`") |> 
  relocate("p.value_unemployment", .after = "unemployment")

# 
print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_rollsum3`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_rollsum3`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_rollsum3`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_rollsum3`" > 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_rollsum3`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_rollsum3`" < 0.1, na.rm = TRUE)
```

##### 10.3.2.2

```{r}
# 5 year period
regression <- map(list_gr5_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum5")]

  # Build the regression formula
  formula <- as.formula(paste("gdp ~ unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg5 <- regg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum5`", .after = "`expenditure_2000-2006_budget_rollsum5`") |>
  relocate("`expenditure_2014-2020_budget_rollsum5`", .after = "`expenditure_2007-2013_budget_rollsum5`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum5`", .after = "`expenditure_1994-1999_budget_rollsum5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum5`", .after = "`expenditure_2000-2006_budget_rollsum5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum5`", .after = "`expenditure_2007-2013_budget_rollsum5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum5`", .after = "`expenditure_2014-2020_budget_rollsum5`") |> 
  relocate("p.value_unemployment", .after = "unemployment")

# 
print(paste("R-squared: ", mean(regg5$r_squared)))
sum(regg5$"`expenditure_1994-1999_budget_rollsum5`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2000-2006_budget_rollsum5`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2007-2013_budget_rollsum5`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2014-2020_budget_rollsum5`" > 0, na.rm = TRUE)
sum(!is.na(regg5$"`expenditure_1994-1999_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2000-2006_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2007-2013_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2014-2020_budget_rollsum5`"))
sum(regg5$"p.value_`expenditure_1994-1999_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2000-2006_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2007-2013_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2014-2020_budget_rollsum5`" < 0.1, na.rm = TRUE)
```

##### 10.3.2.3

```{r}
# 7 year period
regression <- map(list_gr7_cleaned, function(df) {
  # Find column names that start with "expenditure"
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum7")]

  # Build the regression formula
  formula <- as.formula(paste("gdp ~ unemployment +",
                              paste0("`", exp_vars, "`", collapse = " + ")))

  # Run regression
  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg7 <- regg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum7`", .after = "`expenditure_2000-2006_budget_rollsum7`") |>
  relocate("`expenditure_2014-2020_budget_rollsum7`", .after = "`expenditure_2007-2013_budget_rollsum7`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum7`", .after = "`expenditure_1994-1999_budget_rollsum7`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum7`", .after = "`expenditure_2000-2006_budget_rollsum7`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum7`", .after = "`expenditure_2007-2013_budget_rollsum7`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum7`", .after = "`expenditure_2014-2020_budget_rollsum7`") |> 
  relocate("p.value_unemployment", .after = "unemployment")

# 
print(paste("R-squared: ", mean(regg7$r_squared)))
sum(regg7$"`expenditure_1994-1999_budget_rollsum7`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2000-2006_budget_rollsum7`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2007-2013_budget_rollsum7`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2014-2020_budget_rollsum7`" > 0, na.rm = TRUE)
sum(!is.na(regg7$"`expenditure_1994-1999_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2000-2006_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2007-2013_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2014-2020_budget_rollsum7`"))
sum(regg7$"p.value_`expenditure_1994-1999_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2000-2006_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2007-2013_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2014-2020_budget_rollsum7`" < 0.1, na.rm = TRUE)
```

#### 10.3.3 Lagged expenditure with poor binaries

##### 10.3.3.1

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag2")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "gdp ~ unemployment +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag2`", .after = "`expenditure_2000-2006_budget_lag2`") |>
  relocate("`expenditure_2014-2020_budget_lag2`", .after = "`expenditure_2007-2013_budget_lag2`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag2`", .after = "`expenditure_1994-1999_budget_lag2`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag2`", .after = "`expenditure_2000-2006_budget_lag2`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag2`", .after = "`expenditure_2007-2013_budget_lag2`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag2`", .after = "`expenditure_2014-2020_budget_lag2`") |> 
  relocate("p.value_unemployment", .after = "unemployment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# 
print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_lag2`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_lag2`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_lag2`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_lag2`" > 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_lag2`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_lag2`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_lag2`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_lag2`" < 0.1, na.rm = TRUE)
```

##### 10.3.3.2

```{r}
# 5 year period
regression <- map(list_gr5_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag4")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "gdp ~ unemployment +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg5 <- regg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag4`", .after = "`expenditure_2000-2006_budget_lag4`") |>
  relocate("`expenditure_2014-2020_budget_lag4`", .after = "`expenditure_2007-2013_budget_lag4`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag4`", .after = "`expenditure_1994-1999_budget_lag4`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag4`", .after = "`expenditure_2000-2006_budget_lag4`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag4`", .after = "`expenditure_2007-2013_budget_lag4`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag4`", .after = "`expenditure_2014-2020_budget_lag4`") |> 
  relocate("p.value_unemployment", .after = "unemployment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

#
print(paste("R-squared: ", mean(regg5$r_squared)))
sum(regg5$"`expenditure_1994-1999_budget_lag4`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2000-2006_budget_lag4`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2007-2013_budget_lag4`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2014-2020_budget_lag4`" > 0, na.rm = TRUE)
sum(!is.na(regg5$"`expenditure_1994-1999_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2000-2006_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2007-2013_budget_lag4`")) + sum(!is.na(regg5$"`expenditure_2014-2020_budget_lag4`"))
sum(regg5$"p.value_`expenditure_1994-1999_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2000-2006_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2007-2013_budget_lag4`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2014-2020_budget_lag4`" < 0.1, na.rm = TRUE)
```

##### 10.3.3.3

```{r}
# 7 year period
regression <- map(list_gr7_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_lag6")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "gdp ~ unemployment +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg7 <- regg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_lag6`", .after = "`expenditure_2000-2006_budget_lag6`") |>
  relocate("`expenditure_2014-2020_budget_lag6`", .after = "`expenditure_2007-2013_budget_lag6`") |>
  relocate("p.value_`expenditure_1994-1999_budget_lag6`", .after = "`expenditure_1994-1999_budget_lag6`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_lag6`", .after = "`expenditure_2000-2006_budget_lag6`") |>
  relocate("p.value_`expenditure_2007-2013_budget_lag6`", .after = "`expenditure_2007-2013_budget_lag6`") |>
  relocate("p.value_`expenditure_2014-2020_budget_lag6`", .after = "`expenditure_2014-2020_budget_lag6`") |> 
  relocate("p.value_unemployment", .after = "unemployment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

print(paste("R-squared: ", mean(regg7$r_squared)))
sum(regg7$"`expenditure_1994-1999_budget_lag6`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2000-2006_budget_lag6`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2007-2013_budget_lag6`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2014-2020_budget_lag6`" > 0, na.rm = TRUE)
sum(!is.na(regg7$"`expenditure_1994-1999_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2000-2006_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2007-2013_budget_lag6`")) + sum(!is.na(regg7$"`expenditure_2014-2020_budget_lag6`"))
sum(regg7$"p.value_`expenditure_1994-1999_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2000-2006_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2007-2013_budget_lag6`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2014-2020_budget_lag6`" < 0.1, na.rm = TRUE)
```


#### 10.3.4 Summed expenditure with poor binaries

##### 10.3.4.1

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum3")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "gdp ~ unemployment +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})
modelsummary(
    models = regression,
    fmt = fmt_decimal(digits = 2),
    stars = TRUE,
    statistic = NULL,
    coef_map = c("unemployment",
                 "expenditure_1994-1999_budget_rollsum3",
                 "expenditure_2000-2006_budget_rollsum3",
                 "expenditure_2007-2013_budget_rollsum3", 
                 "expenditure_2014-2020_budget_rollsum3",
                 "poor00_06", "poor07_13", "poor14_20"),
    gof_map = list(
        list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
        list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
        list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
    output = "gdp_yesp.md"
)

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum3`", .after = "`expenditure_1994-1999_budget_rollsum3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2014-2020_budget_rollsum3`") |> 
  relocate("p.value_unemployment", .after = "unemployment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

# 
print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_rollsum3`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_rollsum3`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_rollsum3`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_rollsum3`" > 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_rollsum3`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_rollsum3`" < 0.1, na.rm = TRUE)
```

##### 10.3.4.2

```{r}
# 5 year period
regression <- map(list_gr5_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum5")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "gdp ~ unemployment +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg5 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg5 <- regg5 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum5`", .after = "`expenditure_2000-2006_budget_rollsum5`") |>
  relocate("`expenditure_2014-2020_budget_rollsum5`", .after = "`expenditure_2007-2013_budget_rollsum5`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum5`", .after = "`expenditure_1994-1999_budget_rollsum5`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum5`", .after = "`expenditure_2000-2006_budget_rollsum5`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum5`", .after = "`expenditure_2007-2013_budget_rollsum5`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum5`", .after = "`expenditure_2014-2020_budget_rollsum5`") |> 
  relocate("p.value_unemployment", .after = "unemployment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

#
print(paste("R-squared: ", mean(regg5$r_squared)))
sum(regg5$"`expenditure_1994-1999_budget_rollsum5`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2000-2006_budget_rollsum5`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2007-2013_budget_rollsum5`" > 0, na.rm = TRUE) + sum(regg5$"`expenditure_2014-2020_budget_rollsum5`" > 0, na.rm = TRUE)
sum(!is.na(regg5$"`expenditure_1994-1999_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2000-2006_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2007-2013_budget_rollsum5`")) + sum(!is.na(regg5$"`expenditure_2014-2020_budget_rollsum5`"))
sum(regg5$"p.value_`expenditure_1994-1999_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2000-2006_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2007-2013_budget_rollsum5`" < 0.1, na.rm = TRUE) + sum(regg5$"p.value_`expenditure_2014-2020_budget_rollsum5`" < 0.1, na.rm = TRUE)
```

##### 10.3.4.3

```{r}
# 7 year period
regression <- map(list_gr7_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum7")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick only the expenditure vars
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Combine both
  all_vars <- c(exp_vars_bt, poor_vars)

  formula <- as.formula(paste(
    "gdp ~ unemployment +",
    paste(all_vars, collapse = " + ")
  ))

  lm(formula, data = df)
})

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg7 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg7 <- regg7 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum7`", .after = "`expenditure_2000-2006_budget_rollsum7`") |>
  relocate("`expenditure_2014-2020_budget_rollsum7`", .after = "`expenditure_2007-2013_budget_rollsum7`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum7`", .after = "`expenditure_1994-1999_budget_rollsum7`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum7`", .after = "`expenditure_2000-2006_budget_rollsum7`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum7`", .after = "`expenditure_2007-2013_budget_rollsum7`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum7`", .after = "`expenditure_2014-2020_budget_rollsum7`") |> 
  relocate("p.value_unemployment", .after = "unemployment") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

print(paste("R-squared: ", mean(regg7$r_squared)))
sum(regg7$"`expenditure_1994-1999_budget_rollsum7`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2000-2006_budget_rollsum7`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2007-2013_budget_rollsum7`" > 0, na.rm = TRUE) + sum(regg7$"`expenditure_2014-2020_budget_rollsum7`" > 0, na.rm = TRUE)
sum(!is.na(regg7$"`expenditure_1994-1999_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2000-2006_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2007-2013_budget_rollsum7`")) + sum(!is.na(regg7$"`expenditure_2014-2020_budget_rollsum7`"))
sum(regg7$"p.value_`expenditure_1994-1999_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2000-2006_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2007-2013_budget_rollsum7`" < 0.1, na.rm = TRUE) + sum(regg7$"p.value_`expenditure_2014-2020_budget_rollsum7`" < 0.1, na.rm = TRUE)
```

## 11) Interaction terms

### 11.1 Model using absolute value of unemployment

```{r}
regression_ab <- map(list_data_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick expenditure vars to safely include in formula
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Main effects
  all_vars <- c(exp_vars_bt, poor_vars)

  # Create all pairwise interactions: poor  expenditure
  interaction_terms <- expand.grid(poor = poor_vars, exp = exp_vars_bt, stringsAsFactors = FALSE) |>
    pmap_chr(~ paste0(..2, ":", ..1)) 

  # Build final formula
  formula <- as.formula(paste(
    "unemployment ~ . +",
    paste(c(interaction_terms), collapse = " + ")
  ))

  lm(formula, data = df)
})
names(regression_ab) <- names(list_data_cleaned)
modelsummary(
  models = regression_ab,
  fmt = fmt_decimal(digits = 2),
  stars = TRUE,
  statistic = NULL,
  coef_map = c("gdp", "investment", "education", 
               "expenditure_1994-1999_budget", "expenditure_2000-2006_budget",
               "expenditure_2007-2013_budget", "expenditure_2014-2020_budget",
               "poor00_06", "poor07_13", "poor14_20",
               "expenditure_1994-1999_budget:poor00_06",
               "expenditure_2000-2006_budget:poor00_06",
               "expenditure_2000-2006_budget:poor07_13",
               "expenditure_2007-2013_budget:poor07_13",
               "expenditure_2007-2013_budget:poor14_20",
               "expenditure_2014-2020_budget:poor14_20"),
  gof_map = list(
    list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
    list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
    list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
  output = "ab_int.md"
)

rsquared <- map_dbl(regression_ab, ~ summary(.x)$r.squared)
ab <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_ab, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_ab, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

ab <- ab |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_education", .after = "education") |>
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

mean(ab$r_squared)
sum(ab$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(ab$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(ab$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(ab$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(ab$"`expenditure_1994-1999_budget`")) + sum(!is.na(ab$"`expenditure_2000-2006_budget`")) + sum(!is.na(ab$"`expenditure_2007-2013_budget`")) + sum(!is.na(ab$"`expenditure_2014-2020_budget`"))
sum(ab$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(ab$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(ab$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(ab$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

### 11.2 Model using growth rates

```{r}
regression_gr <- map(list_data_gr_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick expenditure vars to safely include in formula
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Main effects
  all_vars <- c(exp_vars_bt, poor_vars)

  # Create all pairwise interactions: poor  expenditure
  interaction_terms <- expand.grid(poor = poor_vars, exp = exp_vars_bt, stringsAsFactors = FALSE) |>
    pmap_chr(~ paste0(..2, ":", ..1)) 

  # Build final formula
  formula <- as.formula(paste(
    "unemployment ~ . +",
    paste(c(interaction_terms), collapse = " + ")
  ))

  lm(formula, data = df)
})
names(regression_gr) <- names(list_data_gr_cleaned)
modelsummary(
  models = regression_gr,
  fmt = fmt_decimal(digits = 2),
  stars = TRUE,
  statistic = NULL,
  coef_map = c("gdp", "investment", "education", 
               "expenditure_1994-1999_budget", "expenditure_2000-2006_budget",
               "expenditure_2007-2013_budget", "expenditure_2014-2020_budget",
               "poor00_06", "poor07_13", "poor14_20",
               "expenditure_1994-1999_budget:poor00_06",
               "expenditure_2000-2006_budget:poor00_06",
               "expenditure_2000-2006_budget:poor07_13",
               "expenditure_2007-2013_budget:poor07_13",
               "expenditure_2007-2013_budget:poor14_20",
               "expenditure_2014-2020_budget:poor14_20"),
  gof_map = list(
    list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
    list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
    list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
  output = "gr_int.md"
)

rsquared <- map_dbl(regression_gr, ~ summary(.x)$r.squared)
gr <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_gr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_gr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

gr <- gr |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_education", .after = "education") |>
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

mean(gr$r_squared)
sum(gr$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(gr$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(gr$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(gr$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(gr$"`expenditure_1994-1999_budget`")) + sum(!is.na(gr$"`expenditure_2000-2006_budget`")) + sum(!is.na(gr$"`expenditure_2007-2013_budget`")) + sum(!is.na(gr$"`expenditure_2014-2020_budget`"))
sum(gr$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(gr$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(gr$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(gr$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

### 11.3 All growth rates

```{r}
regression_allgr <- map(list_data_allgr_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick expenditure vars to safely include in formula
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Main effects
  all_vars <- c(exp_vars_bt, poor_vars)

  # Create all pairwise interactions: poor  expenditure
  interaction_terms <- expand.grid(poor = poor_vars, exp = exp_vars_bt, stringsAsFactors = FALSE) |>
    pmap_chr(~ paste0(..2, ":", ..1)) 

  # Build final formula
  formula <- as.formula(paste(
    "unemployment ~ . +",
    paste(c(interaction_terms), collapse = " + ")
  ))

  lm(formula, data = df)
})
names(regression_allgr) <- names(list_data_allgr_cleaned)
modelsummary(
  models = regression_allgr,
  fmt = fmt_decimal(digits = 2),
  stars = TRUE,
  statistic = NULL,
  coef_map = c("gdp", "investment", "education", 
               "expenditure_1994-1999_budget", "expenditure_2000-2006_budget",
               "expenditure_2007-2013_budget", "expenditure_2014-2020_budget",
               "poor00_06", "poor07_13", "poor14_20",
               "expenditure_1994-1999_budget:poor00_06",
               "expenditure_2000-2006_budget:poor00_06",
               "expenditure_2000-2006_budget:poor07_13",
               "expenditure_2007-2013_budget:poor07_13",
               "expenditure_2007-2013_budget:poor14_20",
               "expenditure_2014-2020_budget:poor14_20"),
  gof_map = list(
    list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
    list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
    list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
  output = "allgr_int.md"
)

rsquared <- map_dbl(regression_allgr, ~ summary(.x)$r.squared)
allgr <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_allgr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_allgr, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

allgr <- allgr |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_education", .after = "education") |>
  relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_investment", .after = "investment") |> 
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

mean(allgr$r_squared)
sum(allgr$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(allgr$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(allgr$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(allgr$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(allgr$"`expenditure_1994-1999_budget`")) + sum(!is.na(allgr$"`expenditure_2000-2006_budget`")) + sum(!is.na(allgr$"`expenditure_2007-2013_budget`")) + sum(!is.na(allgr$"`expenditure_2014-2020_budget`"))
sum(allgr$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(allgr$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(allgr$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(allgr$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

### 11.4 Autoregressive

```{r}
# Absolute terms
regression_auto <- map(list_auto_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick expenditure vars to safely include in formula
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Main effects
  all_vars <- c(exp_vars_bt, poor_vars)

  # Create all pairwise interactions: poor  expenditure
  interaction_terms <- expand.grid(poor = poor_vars, exp = exp_vars_bt, stringsAsFactors = FALSE) |>
    pmap_chr(~ paste0(..2, ":", ..1)) 

  # Build final formula
  formula <- as.formula(paste(
    "unemployment ~ lag_unemployment +",
    paste(c(all_vars, interaction_terms), collapse = " + ")
  ))

  lm(formula, data = df)
})
modelsummary(
  models = regression_auto,
  fmt = fmt_decimal(digits = 2),
  stars = TRUE,
  statistic = NULL,
  coef_map = c("lag_unemployment",
               "expenditure_1994-1999_budget", "expenditure_2000-2006_budget",
               "expenditure_2007-2013_budget", "expenditure_2014-2020_budget",
               "poor00_06", "poor07_13", "poor14_20",
               "expenditure_1994-1999_budget:poor00_06",
               "expenditure_2000-2006_budget:poor00_06",
               "expenditure_2000-2006_budget:poor07_13",
               "expenditure_2007-2013_budget:poor07_13",
               "expenditure_2007-2013_budget:poor14_20",
               "expenditure_2014-2020_budget:poor14_20"),
  gof_map = list(
    list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
    list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
    list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
  output = "autoreg_ab_int.md"
)

rsquared <- map_dbl(regression_auto, ~ summary(.x)$r.squared)
autoreg <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression_auto, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression_auto, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

autoreg <- autoreg |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("`expenditure_2014-2020_budget`", .after = "`expenditure_2007-2013_budget`") |>
  # relocate("p.value_gdp", .after = "gdp") |>
  relocate("p.value_`expenditure_1994-1999_budget`", .after = "`expenditure_1994-1999_budget`") |> 
  relocate("p.value_`expenditure_2000-2006_budget`", .after = "`expenditure_2000-2006_budget`") |>
  relocate("p.value_`expenditure_2007-2013_budget`", .after = "`expenditure_2007-2013_budget`") |>
  relocate("p.value_`expenditure_2014-2020_budget`", .after = "`expenditure_2014-2020_budget`") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20") |>
  relocate("p.value_lag_unemployment", .after = "lag_unemployment")

print(paste("R-squared: ", mean(autoreg$r_squared)))
sum(autoreg$"`expenditure_1994-1999_budget`" < 0, na.rm = TRUE) + sum(autoreg$"`expenditure_2000-2006_budget`" < 0, na.rm = TRUE) + sum(autoreg$"`expenditure_2007-2013_budget`" < 0, na.rm = TRUE) + sum(autoreg$"`expenditure_2014-2020_budget`" < 0, na.rm = TRUE)
sum(!is.na(autoreg$"`expenditure_1994-1999_budget`")) + sum(!is.na(autoreg$"`expenditure_2000-2006_budget`")) + sum(!is.na(autoreg$"`expenditure_2007-2013_budget`")) + sum(!is.na(autoreg$"`expenditure_2014-2020_budget`"))
sum(autoreg$"p.value_`expenditure_1994-1999_budget`" < 0.1, na.rm = TRUE) + sum(autoreg$"p.value_`expenditure_2000-2006_budget`" < 0.1, na.rm = TRUE) + sum(autoreg$"p.value_`expenditure_2007-2013_budget`" < 0.1, na.rm = TRUE) + sum(autoreg$"p.value_`expenditure_2014-2020_budget`" < 0.1, na.rm = TRUE)
```

### 11.5 Growth rates over a long period of time

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum3")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick expenditure vars to safely include in formula
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Main effects
  all_vars <- c(exp_vars_bt, poor_vars)

  # Create all pairwise interactions: poor  expenditure
  interaction_terms <- expand.grid(poor = poor_vars, exp = exp_vars_bt, stringsAsFactors = FALSE) |>
    pmap_chr(~ paste0(..2, ":", ..1)) 

  # Build final formula
  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(c(all_vars, interaction_terms), collapse = " + ")
  ))

  lm(formula, data = df)
})
modelsummary(
    models = regression,
    fmt = fmt_decimal(digits = 2),
    stars = TRUE,
    statistic = NULL,
    coef_map = c("gdp",
                 "expenditure_1994-1999_budget_rollsum3",
                 "expenditure_2000-2006_budget_rollsum3",
                 "expenditure_2007-2013_budget_rollsum3", 
                 "expenditure_2014-2020_budget_rollsum3",
                 "poor00_06", "poor07_13", "poor14_20",
                 "expenditure_1994-1999_budget_rollsum3:poor00_06",
                 "expenditure_2000-2006_budget_rollsum3:poor00_06",
                 "expenditure_2000-2006_budget_rollsum3:poor07_13",
                 "expenditure_2007-2013_budget_rollsum3:poor07_13",
                 "expenditure_2007-2013_budget_rollsum3:poor14_20",
                 "expenditure_2014-2020_budget_rollsum3:poor14_20"),
    gof_map = list(
        list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
        list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
        list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
    output = "okun_int.md"
)

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum3`", .after = "`expenditure_1994-1999_budget_rollsum3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2014-2020_budget_rollsum3`") |> 
  relocate("p.value_gdp", .after = "gdp")

print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_rollsum3`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_rollsum3`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_rollsum3`" < 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_rollsum3`" < 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_rollsum3`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_rollsum3`" < 0.1, na.rm = TRUE)
```

### 11.6 Averages

```{r}
# 3-years period
regression <- map(list_avg3_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_avg3")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick expenditure vars to safely include in formula
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Main effects
  all_vars <- c(exp_vars_bt, poor_vars)

  # Create all pairwise interactions: poor  expenditure
  interaction_terms <- expand.grid(poor = poor_vars, exp = exp_vars_bt, stringsAsFactors = FALSE) |>
    pmap_chr(~ paste0(..2, ":", ..1)) 

  # Build final formula
  formula <- as.formula(paste(
    "unemployment ~ gdp +",
    paste(c(all_vars, interaction_terms), collapse = " + ")
  ))

  lm(formula, data = df)
})
modelsummary(
    models = regression,
    fmt = fmt_decimal(digits = 2),
    stars = TRUE,
    statistic = NULL,
    coef_map = c("gdp",
                 "expenditure_1994-1999_budget_avg3",
                 "expenditure_2000-2006_budget_avg3",
                 "expenditure_2007-2013_budget_avg3", 
                 "expenditure_2014-2020_budget_avg3",
                 "poor00_06", "poor07_13", "poor14_20",
                 "expenditure_1994-1999_budget_avg3:poor00_06",
                 "expenditure_2000-2006_budget_avg3:poor00_06",
                 "expenditure_2000-2006_budget_avg3:poor07_13",
                 "expenditure_2007-2013_budget_avg3:poor07_13",
                 "expenditure_2007-2013_budget_avg3:poor14_20",
                 "expenditure_2014-2020_budget_avg3:poor14_20"),
    gof_map = list(
        list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
        list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
        list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
    output = "avg_int.md"
)

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
avg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

avg3 <- avg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_avg3`", .after = "`expenditure_1994-1999_budget_avg3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_avg3`", .after = "`expenditure_2000-2006_budget_avg3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_avg3`", .after = "`expenditure_2007-2013_budget_avg3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_avg3`", .after = "`expenditure_2014-2020_budget_avg3`") |> 
  relocate("p.value_gdp", .after = "gdp") |> 
  relocate("p.value_poor00_06", .after = "poor00_06") |>
  relocate("p.value_poor07_13", .after = "poor07_13") |>
  relocate("p.value_poor14_20", .after = "poor14_20")

print(paste("R-squared: ", mean(avg3$r_squared)))
sum(avg3$"`expenditure_1994-1999_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2000-2006_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2007-2013_budget_avg3`" < 0, na.rm = TRUE) + sum(avg3$"`expenditure_2014-2020_budget_avg3`" < 0, na.rm = TRUE)
sum(!is.na(avg3$"`expenditure_1994-1999_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2000-2006_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2007-2013_budget_avg3`")) + sum(!is.na(avg3$"`expenditure_2014-2020_budget_avg3`"))
sum(avg3$"p.value_`expenditure_1994-1999_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2000-2006_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2007-2013_budget_avg3`" < 0.1, na.rm = TRUE) + sum(avg3$"p.value_`expenditure_2014-2020_budget_avg3`" < 0.1, na.rm = TRUE)
```

### 11.7 GDP

```{r}
# 3-years period
regression <- map(list_gr3_cleaned, function(df) {
  exp_vars <- names(df)[startsWith(names(df), "expenditure") & endsWith(names(df), "_rollsum3")]
  poor_vars <- names(df)[startsWith(names(df), "poor")]

  # Backtick expenditure vars to safely include in formula
  exp_vars_bt <- paste0("`", exp_vars, "`")

  # Main effects
  all_vars <- c(exp_vars_bt, poor_vars)

  # Create all pairwise interactions: poor  expenditure
  interaction_terms <- expand.grid(poor = poor_vars, exp = exp_vars_bt, stringsAsFactors = FALSE) |>
    pmap_chr(~ paste0(..2, ":", ..1)) 

  # Build final formula
  formula <- as.formula(paste(
    "gdp ~ unemployment +",
    paste(c(all_vars, interaction_terms), collapse = " + ")
  ))

  lm(formula, data = df)
})
modelsummary(
    models = regression,
    fmt = fmt_decimal(digits = 2),
    stars = TRUE,
    statistic = NULL,
    coef_map = c("unemployment",
                 "expenditure_1994-1999_budget_rollsum3",
                 "expenditure_2000-2006_budget_rollsum3",
                 "expenditure_2007-2013_budget_rollsum3", 
                 "expenditure_2014-2020_budget_rollsum3",
                 "poor00_06", "poor07_13", "poor14_20",
                 "expenditure_1994-1999_budget_rollsum3:poor00_06",
                 "expenditure_2000-2006_budget_rollsum3:poor00_06",
                 "expenditure_2000-2006_budget_rollsum3:poor07_13",
                 "expenditure_2007-2013_budget_rollsum3:poor07_13",
                 "expenditure_2007-2013_budget_rollsum3:poor14_20",
                 "expenditure_2014-2020_budget_rollsum3:poor14_20"),
    gof_map = list(
        list("raw" = "nobs", "clean" = "N, Obs", "fmt" = 0),
        list("raw" = "r.squared", "clean" = "R2", "fmt" = 2),
        list("raw" = "adj.r.squared", "clean" = "Adj. R2", "fmt" = 2)),
    output = "gdp_yesp_int.md"
)

rsquared <- map_dbl(regression, ~ summary(.x)$r.squared)
regg3 <- tibble(
  year = names(rsquared),
  r_squared = as.numeric(rsquared)
)

coefficients <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, estimate) |>
  pivot_wider(names_from = term, values_from = estimate)
pvals <- map_dfr(regression, ~ broom::tidy(.x), .id = "year") |> 
  filter(term != "(Intercept)") |> 
  select(year, term, p.value) |> 
  pivot_wider(names_from = term, values_from = p.value, names_prefix = "p.value_")

regg3 <- regg3 |> 
  left_join(coefficients, by = "year") |> 
  left_join(pvals, by = "year") |>
  mutate(across(where(is.numeric), ~ round(.x, 6))) |> 
  relocate("`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_1994-1999_budget_rollsum3`", .after = "`expenditure_1994-1999_budget_rollsum3`") |> 
  relocate("p.value_`expenditure_2000-2006_budget_rollsum3`", .after = "`expenditure_2000-2006_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2007-2013_budget_rollsum3`", .after = "`expenditure_2007-2013_budget_rollsum3`") |>
  relocate("p.value_`expenditure_2014-2020_budget_rollsum3`", .after = "`expenditure_2014-2020_budget_rollsum3`") |> 
  relocate("p.value_unemployment", .after = "unemployment")


print(paste("R-squared: ", mean(regg3$r_squared)))
sum(regg3$"`expenditure_1994-1999_budget_rollsum3`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2000-2006_budget_rollsum3`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2007-2013_budget_rollsum3`" > 0, na.rm = TRUE) + sum(regg3$"`expenditure_2014-2020_budget_rollsum3`" > 0, na.rm = TRUE)
sum(!is.na(regg3$"`expenditure_1994-1999_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2000-2006_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2007-2013_budget_rollsum3`")) + sum(!is.na(regg3$"`expenditure_2014-2020_budget_rollsum3`"))
sum(regg3$"p.value_`expenditure_1994-1999_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2000-2006_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2007-2013_budget_rollsum3`" < 0.1, na.rm = TRUE) + sum(regg3$"p.value_`expenditure_2014-2020_budget_rollsum3`" < 0.1, na.rm = TRUE)
```





Look at papers to see how they model unemployment

1-  y = average growth rate over funding periods.
    x = poor binary
    model = fuzzy regression discontinuity
2-  y = logarithmic growth rate of employees in the manufacturing sector over 2 "long" periods of times (2000-2010 and 201014)
    x = poor binary
    model = spatial regression discontinuity
3-  y = total employment variation between 1991 and 2001
    x = controls on socioeconomic conditions of regions
    model = spatial regression discontinuity

Potential new variables

  - GVA instead of GDP
  - Compensation of Employees at constant prices
  - Real compensation per hour worked
  - Real labour productivity per hour worked
  - Early leavers from education and training (18-24 years)
  - Young people neither in employment nor in education and training (NEET, 15-29 years) 